# v0.2.1 Release Notes

**Release Date**: 2025-11-10
**Type**: Bug Fix + Feature Enhancement Release

## Overview

v0.2.1 addresses 4 critical bugs that prevented core functionality in v0.2.0 and adds a major enhancement: academic-quality IEEE citation system with page-level tracking for PDFs.

## Critical Bug Fixes

### 1. Ollama Model Verification (HIGH PRIORITY)
**Issue**: Ollama Python library returns `ListResponse` object, not dictionary
**Files**: `ollama_client.py:63`, `ollama_embedder.py:74`
**Fix**: Changed `models.get('models', [])` to `models.models` and `m['name']` to `m.model`
**Impact**: Model availability checks now work correctly

### 2. Document Ingestion (HIGH PRIORITY)
**Issue**: Multiple ingestion problems blocking document upload
**Files**: `main.py:68,74,82-85`, `splitters.py:135-172`
**Fixes**:
- `chunk_document()` now returns Document (was returning chunks list)
- Changed `chunk.content` to `chunk.text` (correct Pydantic field name)
- Added Path→string serialization for ChromaDB metadata
**Impact**: Document ingestion now works end-to-end

### 3. Default LLM Model (MEDIUM PRIORITY)
**Issue**: Default model `llama3.2:3b` may not be installed
**File**: `settings.py:52`
**Fix**: Changed default to `llama3.2:latest`
**Impact**: Better out-of-box experience

### 4. Docker Health Check (MEDIUM PRIORITY)
**Issue**: Health check endpoint mismatch
**File**: `docker-compose.yml:30`
**Fix**: Changed URL from `/health` to `/api/health`
**Impact**: Docker containers now start correctly

## Major Enhancement: IEEE Citation System

### Features Added

1. **Citation Formatter Module** (NEW FILE: `citation_formatter.py`)
   - `extract_citation_numbers()`: Extract [N] citations from text
   - `format_ieee_reference()`: Format single reference in IEEE style
   - `format_reference_list()`: Create numbered reference list
   - `format_response_with_references()`: Full response formatting

2. **Page Tracking for PDFs**
   - PDF loader now adds `<!-- PAGE N -->` markers during extraction
   - Character-level position mapping preserves page information through chunking
   - ChunkMetadata extended with `page_number` and `page_range` fields
   - 7 new helper functions in `splitters.py` for page mapping

3. **Enhanced Prompts**
   - RAG_SYSTEM_PROMPT updated to request numbered citations [1], [2], [3]
   - Instructions to use only provided citation numbers
   - Guidance on citation placement and reuse

4. **Automatic Reference Formatting**
   - CLI query command now formats responses with IEEE references
   - Shows only cited sources (configurable)
   - Format: `[1] filename.pdf, p. 42` or `[2] report.txt, pp. 10-12`

### Technical Implementation

**Page Tracking Algorithm**:
1. PDF pages extracted individually with markers
2. Markers preserved through document loading
3. Position map built: `[(page_num, position), ...]`
4. Content cleaned for chunking (markers removed)
5. Clean→original position mapping created
6. Each chunk mapped back to page(s) via positions
7. Fallback: Linear estimation if precise tracking fails

**Citation Flow**:
1. User asks question
2. Chunks retrieved (now with page info)
3. LLM generates response with [1], [2], [3]
4. Citation formatter parses numbers
5. Reference list built from chunk metadata
6. Formatted response displayed with references

## Files Modified

**Bug Fixes** (5 files):
- `src/generation/ollama_client.py`
- `src/embeddings/ollama_embedder.py`
- `src/main.py`
- `src/config/settings.py`
- `docker-compose.yml`

**Citation System** (7 files + 1 new):
- `src/generation/citation_formatter.py` (NEW)
- `src/ingestion/models.py`
- `src/ingestion/loaders.py`
- `src/chunking/splitters.py`
- `src/generation/prompts.py`
- `src/retrieval/retriever.py`
- `src/main.py`

**Documentation** (3 files):
- `CHANGELOG.md`
- `README.md`
- `docs/development/devlog/v0.2/v0.2.1-release-notes.md`

## Testing

- 261 v0.2 tests passing (maintained compatibility)
- All bug fixes verified working on separate installation
- Citation system tested with PDF documents

## Breaking Changes

None. v0.2.1 is fully backward compatible with v0.2.0.

## Upgrade Notes

1. Pull latest code: `git pull origin main`
2. Activate venv: `source .venv-v0.2/bin/activate`
3. No dependency changes required
4. Restart services if running: `docker-compose restart`

## Known Issues

- Some integration tests require ChromaDB running (61 tests)
- These are test environment issues, not runtime bugs

## Credits

Implementation based on bug fixes document from separate installation testing.
All code changes implemented with AI assistance (Claude Code).

## Next Steps

v0.3 planning:
- Multi-modal support (images, tables)
- Knowledge graph integration
- Advanced query processing
- Collaborative filtering
