# v0.2.5 Design Goals

**Version**: 0.2.5
**Type**: Code Quality & Bug Fix Release
**Status**: Planned
**Created**: 2025-11-17

---

## Vision

Establish a stable, high-quality codebase foundation by systematically eliminating technical debt before adding new features. v0.2.5 focuses exclusively on code quality improvements, bug fixes, and developer experience enhancements without introducing new functionality.

**Core Principle**: Pay down technical debt now to accelerate feature development later.

---

## Success Criteria

### 1. Code Quality Metrics

**Critical Eliminations**:
- ✅ **0** bare `except:` handlers (currently: 1)
- ✅ **<10** generic `except Exception` handlers (currently: 38)
- ✅ **0** obsolete TODO comments (currently: 8)
- ✅ **0** magic numbers in critical paths (currently: 50+)

**Quality Improvements**:
- ✅ **100%** type hint coverage (currently: ~85%)
- ✅ **>80%** test coverage on all modules (currently: ~60% average)
- ✅ **0 errors** from `mypy --strict src/`

### 2. Bug Fixes

**Critical Bugs**:
- ✅ Settings side effects eliminated (enables clean testing)
- ✅ Contextual chunker overlap calculation implemented
- ✅ All security vulnerabilities addressed

### 3. Test Coverage

**New Tests**:
- ✅ **18 tests** implemented (13 splitter + 5 citation parser)
- ✅ **0 skipped tests** in critical modules (currently: 19)
- ✅ **100%** test pass rate

### 4. Developer Experience

**Improvements**:
- ✅ Clear, specific error messages with context
- ✅ Consistent constants module for configuration
- ✅ Type safety enforced throughout codebase
- ✅ Comprehensive test coverage enables confident refactoring

---

## Design Decisions

### DD-001: Lazy Directory Creation

**Decision**: Remove directory creation from `Settings.model_post_init()` and implement lazy creation pattern.

**Rationale**:
- Eliminates side effects during object initialization
- Enables clean unit testing without filesystem I/O
- Follows best practice: constructors should not have side effects
- Works in all deployment environments (Docker, CI/CD, local, serverless)

**Implementation**:
- Add `Settings.ensure_data_dir() -> Path` method
- Update all call sites to use lazy creation
- Remove `mkdir()` from `model_post_init()`

**Trade-offs**:
- Slightly more verbose at call sites (explicit `ensure_data_dir()` call)
- Benefit: Explicit resource management, better error handling

---

### DD-002: Centralised Constants Module

**Decision**: Create `src/config/constants.py` for all magic numbers and configuration constants.

**Rationale**:
- Single source of truth for configuration values
- Easier to maintain and update
- Improves code readability
- Enables type-safe constant access

**Structure**:
```python
# Service defaults
OLLAMA_DEFAULT_PORT = 11434
CHROMA_DEFAULT_PORT = 8001

# Chunking
DEFAULT_CHUNK_SIZE_TOKENS = 500
CHARS_PER_TOKEN_ESTIMATE = 4

# Embeddings
MINILM_EMBEDDING_DIM = 384
# ... etc
```

**Trade-offs**:
- Initial migration effort (~3h)
- Benefit: Long-term maintainability, consistency

---

### DD-003: Specific Exception Types Over Generic Handlers

**Decision**: Replace all generic `except Exception` with specific exception types.

**Rationale**:
- Enables precise error handling
- Prevents catching system exits and keyboard interrupts
- Improves debugging with specific error context
- Security: Prevents masking critical errors

**Pattern**:
```python
# Before:
try:
    api_call()
except Exception as e:
    logger.error(f"Failed: {e}")

# After:
try:
    api_call()
except (RequestException, JSONDecodeError) as e:
    raise APIError(f"API request failed") from e
except Exception as e:
    logger.error(f"Unexpected error: {e}")
    raise
```

**Trade-offs**:
- Requires identifying specific exception types for each handler (~10h)
- Benefit: Better error handling, debugging, and security

---

### DD-004: Strict Type Checking with mypy

**Decision**: Enforce `mypy --strict` compliance across entire codebase.

**Rationale**:
- Catches type errors at development time
- Improves IDE autocomplete and refactoring tools
- Self-documenting code through type annotations
- Industry best practice for Python projects

**Implementation**:
- Add `from __future__ import annotations` to all modules
- Add return type hints to all functions
- Use `| None` for optional parameters
- Add type stubs for third-party libraries if needed

**Trade-offs**:
- Initial effort to add ~78 missing type hints (~8h)
- Benefit: Prevents entire classes of runtime errors

---

### DD-005: Comprehensive Test Coverage

**Decision**: Implement all 19 skipped tests (13 splitter + 5 parser + 1 integration).

**Rationale**:
- Critical modules must have >80% coverage
- Skipped tests represent technical debt
- Comprehensive tests enable confident refactoring
- Foundation for future feature development

**Focus**:
1. **Chunking tests**: Core functionality, used by all ingestion
2. **Citation parser tests**: User-facing feature
3. **Integration tests**: End-to-end verification

**Trade-offs**:
- ~10h implementation effort
- Benefit: Confidence in code quality, prevent regressions

---

### DD-006: Exception Chaining

**Decision**: Add exception chaining (`raise CustomError() from e`) to all re-raised exceptions.

**Rationale**:
- Preserves original exception context
- Improves debugging with full stack traces
- Python best practice (PEP 409)

**Pattern**:
```python
except OriginalError as e:
    raise CustomError("Operation failed") from e  # Preserves chain
```

**Trade-offs**:
- Minor implementation effort (~2h)
- Benefit: Significantly better debugging experience

---

## Out of Scope

v0.2.5 explicitly **excludes** the following to maintain focus on quality:

### 1. New Features
**Deferred to v0.2.7+**:
- Model switching UI
- Collection management
- Query suggestions
- Async processing
- CLI enhancements
- Export/import functionality

**Rationale**: Quality first, features second

---

### 2. Major Refactoring
**Deferred to v0.2.6**:
- File length refactoring (main.py, gradio_ui.py)
- Complex function extraction
- Code duplication elimination
- Structural reorganisation

**Rationale**: v0.2.5 focuses on bugs and quality, v0.2.6 on structure

---

### 3. Performance Optimisation
**Deferred to v0.2.8+**:
- Query performance tuning
- Embedding cache optimisation
- Lazy loading improvements
- Async/await patterns

**Rationale**: Optimise correct code, not broken code

---

### 4. Documentation Improvements
**Deferred to v0.2.6**:
- Complete Google-style docstrings
- Usage examples in documentation
- Tutorial improvements

**Rationale**: Code quality first, then documentation polish

---

### 5. Breaking Changes
**Never in v0.2.x**:
- API changes
- Schema changes (unless absolutely necessary)
- Dependency updates requiring code changes

**Rationale**: Maintain backward compatibility throughout v0.2.x

---

## Dependencies

### Required Versions

v0.2.5 **requires** completion of:
- ✅ v0.2.4 (all 8 bugs fixed)

v0.2.5 **blocks**:
- v0.2.6 (structural improvements depend on quality foundation)
- v0.2.7 (features depend on stable base)

### External Dependencies

**No new dependencies** added in v0.2.5.

**Existing dependencies** remain:
- Python 3.12.x
- All v0.2.4 dependencies (ollama, chromadb, psutil, etc.)

---

## Related Documentation

### Planning Documents
- [v0.2 Planning Overview](./README.md) - Version 0.2 high-level planning
- [v0.2.4 Roadmap](../../roadmap/version/v0.2.4/README.md) - Previous version roadmap
- [v0.2.6 Design Goals](./v0.2.6-design.md) - Next version design

### Roadmap Documents
- [v0.2.5 Roadmap](../../roadmap/version/v0.2.5/README.md) - Detailed implementation plan
- [v0.2.6 Roadmap](../../roadmap/version/v0.2.6/README.md) - Next version roadmap

### Implementation Documents
- [v0.2.4 Release Notes](../../implementation/version/v0.2/v0.2.4.md) - Previous version results

---

**Last Updated**: 2025-11-17
**Status**: ✅ Complete - Ready for roadmap creation
**Next Step**: Create v0.2.5 roadmap documentation
