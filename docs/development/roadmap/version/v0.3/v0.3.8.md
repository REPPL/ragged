# v0.3.8 - Developer Experience I

**Category:** CLI - Interactive & Debug

**Estimated Time:** 20-24 hours

**Status:** Planned

---

## Overview

Exploratory workflows and debugging tools for power users and developers.

**Target Users:** Developers, researchers, power users wanting fine-grained control

**Key Innovation:** REPL interface brings Python-like exploratory workflow to RAG systems, enabling rapid iteration and debugging.

---

## Prerequisites

**Security & Privacy Foundation (REQUIRED):**

All v0.3.x versions depend on the security and privacy infrastructure established in v0.2.10 and v0.2.11. These versions MUST be completed before implementing any v0.3.x features.

- âœ… **v0.2.10 (Security Hardening)** - Eliminates Pickle vulnerabilities, implements session isolation, establishes security testing framework
- âœ… **v0.2.11 (Privacy Infrastructure)** - Provides encryption at rest, PII detection/redaction, data lifecycle management, GDPR compliance

**Why Required:** v0.3.0 stores REPL session history which may contain sensitive queries. v0.2.11 provides encrypted session file storage, ensuring user data privacy.

---

## Features

### CLI-012: Interactive Mode (8-10h)

**Priority:** High
**Dependencies:** v0.3.0 (configuration system)

#### Scope

REPL (Read-Eval-Print Loop) interface for exploratory RAG workflows.

**Use Cases:**
- Iterative query refinement
- Document exploration
- Configuration testing
- Retrieval parameter tuning
- Learning ragged's capabilities

**User Experience:**
```bash
$ ragged interactive

ðŸ” ragged v0.3.0 - Interactive Mode
Type 'help' for commands, 'exit' to quit

ragged> add documents/paper.pdf
âœ“ Added paper.pdf with 127 chunks

ragged> query "what are the main findings?"
ðŸ“„ Retrieved 5 chunks (0.92 avg confidence)

Answer: The main findings include...
[answer displayed]

ragged> show chunks
Chunk 1: [paper.pdf, page 3, confidence: 0.95]
"The primary discovery was that..."

ragged> set retrieval.top_k 10
âœ“ retrieval.top_k = 10

ragged> query "what are the main findings?"
ðŸ“„ Retrieved 10 chunks (0.87 avg confidence)
[different answer with more chunks]

ragged> help config
Configuration commands:
  set <key> <value>    - Set configuration value
  get <key>            - Get configuration value
  show config          - Display current configuration
  reset config         - Reset to defaults
```

#### Implementation Overview

- **Module:** `src/cli/interactive.py`
- **Approach:** Python's `cmd` module for REPL
- **Libraries:** cmd (stdlib), prompt_toolkit (enhanced input)
- **Integration:** Full access to ragged's API

#### Key Components

- `InteractiveShell` class (extends `cmd.Cmd`)
- Command parser and dispatcher
- Context management (session state)
- Configuration live updates
- History tracking and persistence
- Tab completion
- Multi-line input support

---

### CLI-018: Debug Mode (4-5h)

**Priority:** Medium
**Dependencies:** v0.3.0 (confidence scoring)

#### Scope

Step-by-step execution visualisation for understanding RAG pipeline.

**Use Cases:**
- Understanding retrieval decisions
- Debugging poor results
- Learning RAG mechanics
- Validating configurations
- Troubleshooting performance

**User Experience:**
```bash
$ ragged query --debug "what are the main findings?"

ðŸ” Debug Mode: Query Pipeline

[Step 1/6] Query Preprocessing
  Original: "what are the main findings?"
  Normalised: "what are the main findings"
  Duration: 2ms

[Step 2/6] Query Embedding
  Model: sentence-transformers/all-MiniLM-L6-v2
  Dimensions: 384
  Duration: 45ms

[Step 3/6] Vector Retrieval
  Database: ChromaDB
  Query: top_k=5, filters={}
  Retrieved: 5 chunks
  Duration: 23ms

[Step 4/6] Reranking
  Model: cross-encoder/ms-marco-MiniLM-L-6-v2
  Input chunks: 5
  Output chunks: 5 (reordered)
  Duration: 67ms

[Step 5/6] Context Building
  Chunks: 5
  Total tokens: 1,247
  Max context: 4,096
  Duration: 3ms

[Step 6/6] Generation
  Model: gpt-3.5-turbo
  Temperature: 0.7
  Tokens: input=1,247, output=156
  Duration: 1,234ms

âœ“ Total Pipeline Duration: 1,374ms

Answer: The main findings include...
```

#### Implementation Overview

- **Module:** Enhance `src/cli/commands/query.py`
- **Approach:** Pipeline instrumentation with logging hooks
- **Integration:** Works with all retrieval strategies

#### Key Components

- `DebugLogger` class
- Pipeline step timing
- Intermediate result capture
- Formatted debug output
- Optional verbose mode
- Performance profiling integration

---

## Privacy & Security Implementation

**Critical Privacy Requirements:** REPL sessions store command history, configuration changes, and query results which may contain PII. All session data MUST be protected using v0.2.11 privacy infrastructure.

### Session Data Protection (v0.2.11 Integration)

**1. Encrypted Session Files**

All REPL session data is encrypted at rest using v0.2.11's encryption manager:

```python
# src/cli/interactive.py - Session persistence
from src.security.encryption import get_encryption_manager
from src.core.session import Session

class InteractiveShell(cmd.Cmd):
    def __init__(self):
        super().__init__()
        self.session = Session()  # v0.2.10 session isolation
        self.encryption = get_encryption_manager()  # v0.2.11 encryption

    def save_session(self, filepath: Path) -> None:
        """Save REPL session with encryption (v0.2.11)."""
        session_data = {
            "session_id": self.session.session_id,
            "commands": self.history,  # Command history
            "config_changes": self.config_changes,
            "context": self.context,
            "timestamp": datetime.now().isoformat()
        }

        # Use v0.2.11 Session.save_to_file (encrypted)
        self.session.metadata["repl_data"] = session_data
        self.session.save_to_file(filepath)

        logger.info(f"Session saved (encrypted): {filepath}")
```

**File Location:** `~/.ragged/sessions/repl_<session_id>.enc`
**Encryption:** Fernet (AES-128) via v0.2.11
**Permissions:** 0o600 (user read/write only)

**2. Command History Privacy**

REPL command history may contain sensitive queries:

```python
# Command history with PII protection
from src.security.pii import hash_query, contains_pii

class InteractiveShell(cmd.Cmd):
    def precmd(self, line: str) -> str:
        """Pre-process command before execution."""
        # Warn if command contains PII
        if contains_pii(line):
            self.stdout.write(
                "âš ï¸  Command appears to contain PII. "
                "Session history will be encrypted.\n"
            )

        # Store command in history (will be encrypted on save)
        self.history.append({
            "timestamp": datetime.now().isoformat(),
            "command": line,
            "command_hash": hash_query(line)  # For logging (v0.2.11)
        })

        return line
```

**Logged:** Only command hash (not plaintext)
**Stored:** Encrypted in session file
**TTL:** Session files expire after 7 days (v0.2.11 lifecycle management)

**3. Session Cleanup**

Automatic cleanup of old REPL sessions using v0.2.11 lifecycle management:

```python
# Cleanup integration with v0.2.11
from src.core.cleanup import get_cleanup_scheduler

# REPL sessions cleaned up automatically
def cleanup_repl_sessions() -> int:
    """Clean up expired REPL session files."""
    from src.config.settings import get_settings
    settings = get_settings()

    session_dir = Path.home() / ".ragged" / "sessions"
    cutoff = datetime.now() - timedelta(days=settings.session_ttl_days)

    removed = 0
    for session_file in session_dir.glob("repl_*.enc"):
        if session_file.stat().st_mtime < cutoff.timestamp():
            session_file.unlink()
            removed += 1
            logger.info(f"Removed expired REPL session: {session_file.name}")

    return removed

# Register with v0.2.11 cleanup scheduler
cleanup_scheduler = get_cleanup_scheduler()
cleanup_scheduler.register_cleanup_task(cleanup_repl_sessions)
```

**Default TTL:** 7 days
**User Control:** Configurable via `session_ttl_days`
**Manual Cleanup:** `ragged cleanup expired`

### Privacy Configuration

Users can control REPL privacy settings:

```python
# Privacy controls for REPL
class Settings(BaseSettings):
    # REPL-specific privacy
    repl_save_history: bool = True  # Can disable history saving
    repl_session_ttl_days: int = 7  # Session expiration
    repl_warn_on_pii: bool = True   # PII detection warnings
    repl_auto_save: bool = False    # Auto-save on exit (default: manual)
```

**Privacy Commands in REPL:**

```bash
ragged> privacy show
Privacy Settings for REPL:
  History Saving: Enabled (encrypted)
  Session TTL: 7 days
  PII Warnings: Enabled
  Auto-Save: Disabled

ragged> privacy disable-history
âœ“ History saving disabled for this session

ragged> privacy clear-history
âš ï¸  This will delete all REPL session files. Continue? (y/n): y
âœ“ Cleared 3 REPL session files
```

### GDPR Compliance

**Right to Deletion:**
```python
# GDPR deletion integration (v0.2.11)
def delete_repl_data(session_id: Optional[str] = None) -> None:
    """Delete REPL data (GDPR Article 17)."""
    session_dir = Path.home() / ".ragged" / "sessions"

    if session_id:
        # Delete specific session
        session_file = session_dir / f"repl_{session_id}.enc"
        if session_file.exists():
            session_file.unlink()
    else:
        # Delete all REPL sessions
        for session_file in session_dir.glob("repl_*.enc"):
            session_file.unlink()
```

**Right to Export:**
```python
# Export REPL session data (GDPR Article 20)
def export_repl_data(output_path: Path) -> None:
    """Export all REPL session data."""
    from src.security.encryption import get_encryption_manager
    import json

    encryption = get_encryption_manager()
    session_dir = Path.home() / ".ragged" / "sessions"

    export = {
        "export_timestamp": datetime.now().isoformat(),
        "sessions": []
    }

    for session_file in session_dir.glob("repl_*.enc"):
        # Decrypt and export
        with open(session_file, 'rb') as f:
            encrypted = f.read()
        decrypted = encryption.decrypt(encrypted)
        session_data = json.loads(decrypted.decode('utf-8'))

        export["sessions"].append(session_data)

    with open(output_path, 'w') as f:
        json.dump(export, f, indent=2)
```

### Security Considerations

**1. Session Isolation (v0.2.10)**

Each REPL invocation gets unique session ID:
- Prevents cross-session data leakage
- Session-scoped caching (query results isolated)
- Clean session state on exit

**2. No Plaintext Logging**

All logging uses query hashing from v0.2.11:

```python
# Logging in REPL (privacy-safe)
logger.info(f"REPL command executed: {hash_query(command)}")  # Hashed
# NOT: logger.info(f"REPL command: {command}")  # Would leak PII
```

**3. Secure Defaults**

- History saving: Enabled but encrypted
- Auto-save: Disabled (requires explicit `save` command)
- Session files: User-only permissions (0o600)
- Old sessions: Auto-deleted after TTL

### Privacy Risk Assessment

| Risk | Likelihood | Impact | Mitigation (v0.2.11) |
|------|-----------|--------|---------------------|
| Command history contains PII | HIGH | HIGH | Encrypted session files |
| Session files readable by others | MEDIUM | CRITICAL | File permissions 0o600 |
| Sessions persist indefinitely | MEDIUM | HIGH | TTL-based cleanup (7 days) |
| Cross-user session access | LOW | CRITICAL | Session isolation (v0.2.10) |
| Logs contain queries | LOW | MEDIUM | Query hashing, not plaintext |

**Privacy Score:** 90/100 (Excellent with v0.2.10/v0.2.11)

### Implementation Checklist

**Privacy Requirements:**
- [ ] Session files encrypted using v0.2.11 EncryptionManager
- [ ] File permissions set to 0o600 on session files
- [ ] Command history sanitized (no plaintext in logs)
- [ ] PII warnings displayed when detected
- [ ] TTL cleanup registered with v0.2.11 scheduler
- [ ] Privacy commands implemented (`privacy show`, `privacy clear-history`)
- [ ] GDPR deletion/export integrated
- [ ] Session isolation tested (no cross-session leakage)
- [ ] Privacy documentation complete

**Testing:**
- [ ] Verify session files are encrypted (not plaintext)
- [ ] Verify file permissions are 0o600
- [ ] Test TTL cleanup removes old sessions
- [ ] Test PII warning displays correctly
- [ ] Test privacy commands work
- [ ] Test GDPR deletion removes all data
- [ ] Test session isolation (parallel REPL instances)

---

## Implementation Phases

### Phase 1: Design & Architecture (4-5h)

**Sessions 1:**
- Use ux-architect agent for REPL UX design
- Design command structure
- Design session state management
- Plan tab completion
- Plan debug output format

**Deliverables:**
- REPL command reference
- Debug output format spec
- UX design validated

### Phase 2: Interactive Mode Implementation (8-10h)

**Sessions 2-4:**
- Implement `InteractiveShell` class
- Command parser and dispatcher
- Core commands: add, query, show, set, get, reset
- Session state management
- History tracking (save/load)
- Tab completion
- Multi-line input
- Unit tests
- UX testing

**Deliverables:**
- REPL fully functional
- Commands working
- Tests passing

### Phase 3: Debug Mode Implementation (4-5h)

**Sessions 5-6:**
- Implement `DebugLogger` class
- Pipeline instrumentation
- Step timing and capture
- Formatted output
- Integration with existing commands
- Unit tests

**Deliverables:**
- Debug mode working
- All pipeline steps instrumented
- Tests passing

### Phase 4: Documentation & Release (2-3h)

**Session 7:**
- Use documentation-architect agent
- Document interactive commands
- Document debug mode
- Create usage examples
- Use documentation-auditor agent
- Use git-documentation-committer agent
- Tag v0.3.8 release

**Deliverables:**
- Complete documentation
- Release tagged

---

## Technical Architecture

### Module Structure

```
src/cli/
â”œâ”€â”€ interactive.py              # REPL implementation (300 lines)
â”‚   â””â”€â”€ class InteractiveShell
â”œâ”€â”€ debug.py                    # Debug logging (200 lines)
â”‚   â””â”€â”€ class DebugLogger
â”œâ”€â”€ commands/
â”‚   â”œâ”€â”€ query.py                # Enhanced with debug mode
â”‚   â””â”€â”€ interactive_commands.py # REPL-specific commands
â””â”€â”€ completion.py               # Tab completion (100 lines)

tests/cli/
â”œâ”€â”€ test_interactive.py
â””â”€â”€ test_debug.py
```

### Interactive Shell Commands

**Document Management:**
- `add <file>` - Add document to library
- `remove <pattern>` - Remove documents
- `list` - List all documents
- `show <document>` - Show document details

**Query Commands:**
- `query <question>` - Ask question
- `search <keywords>` - Keyword search
- `similar <text>` - Find similar chunks

**Configuration:**
- `set <key> <value>` - Set config value
- `get <key>` - Get config value
- `show config` - Display configuration
- `reset config` - Reset to defaults
- `load config <file>` - Load configuration
- `save config <file>` - Save configuration

**Session Management:**
- `history` - Show command history
- `save session <file>` - Save session state
- `load session <file>` - Restore session
- `clear` - Clear screen
- `exit` / `quit` - Exit REPL

**Information:**
- `help [command]` - Show help
- `status` - Show system status
- `stats` - Show library statistics

### Debug Mode Architecture

```python
# Debug logger integration
class DebugLogger:
    def __init__(self, enabled: bool = False):
        self.enabled = enabled
        self.steps: List[DebugStep] = []

    def log_step(self, name: str, details: Dict[str, Any]):
        if self.enabled:
            step = DebugStep(
                name=name,
                timestamp=time.time(),
                details=details
            )
            self.steps.append(step)

    def render(self) -> str:
        """Format debug output for display."""
        output = []
        for i, step in enumerate(self.steps, 1):
            output.append(f"[Step {i}/{len(self.steps)}] {step.name}")
            for key, value in step.details.items():
                output.append(f"  {key}: {value}")
            output.append(f"  Duration: {step.duration}ms")
        return "\n".join(output)

# Pipeline integration
def query_with_debug(question: str, debug: bool = False):
    logger = DebugLogger(enabled=debug)

    # Step 1: Preprocessing
    logger.log_step("Query Preprocessing", {
        "original": question,
        "normalised": preprocess(question)
    })

    # Step 2: Embedding
    logger.log_step("Query Embedding", {
        "model": embedding_model,
        "dimensions": len(embedding)
    })

    # ... more steps

    if debug:
        print(logger.render())

    return answer
```

### Session State Management

```python
class SessionState:
    """Persistent session state for REPL."""

    def __init__(self):
        self.config: Dict[str, Any] = {}
        self.history: List[str] = []
        self.context: Dict[str, Any] = {}

    def save(self, filepath: Path):
        """Save session to file."""
        with open(filepath, 'w') as f:
            json.dump({
                'config': self.config,
                'history': self.history,
                'context': self.context
            }, f, indent=2)

    def load(self, filepath: Path):
        """Restore session from file."""
        with open(filepath, 'r') as f:
            data = json.load(f)
            self.config = data['config']
            self.history = data['history']
            self.context = data['context']
```

---

## Risk Analysis & Mitigation

**Risk 1: REPL Session State Corruption**
- **Impact:** Medium - Lost work, confused state
- **Probability:** Low - JSON serialisation is robust
- **Mitigation:** Auto-save session, validation on load, graceful degradation
- **Detection:** Session load validation, error handling

**Risk 2: Debug Mode Performance Overhead**
- **Impact:** Low - Slower queries in debug mode
- **Probability:** High - Instrumentation adds overhead
- **Mitigation:** Debug mode is opt-in, overhead acceptable for debugging, can disable specific steps
- **Detection:** Performance profiling

**Risk 3: Poor REPL UX (Discoverability)**
- **Impact:** Medium - Users don't use interactive mode
- **Probability:** Medium - REPL discoverability varies
- **Mitigation:** Excellent help system, tab completion, examples in docs, welcome message with hints
- **Detection:** User testing, feedback

**Risk 4: Command Name Conflicts**
- **Impact:** Low - Confusing commands
- **Probability:** Low - Careful naming
- **Mitigation:** Consistent naming scheme, aliases for common commands, help shows all commands
- **Detection:** Manual review, user testing

---

## Quality Gates

### Functional Requirements
- [ ] Interactive mode launches successfully
- [ ] All core commands work (add, query, show, set, get)
- [ ] Session state saves and loads correctly
- [ ] History tracking works
- [ ] Tab completion works
- [ ] Multi-line input supported
- [ ] Debug mode shows all pipeline steps
- [ ] Debug timing accurate
- [ ] Debug output readable and informative
- [ ] Help system comprehensive

### Performance Requirements
- [ ] REPL startup <500ms
- [ ] Command execution overhead <50ms
- [ ] Tab completion responds <100ms
- [ ] Debug mode overhead <200ms per query

### UX Requirements
- [ ] REPL discoverable (help, welcome message)
- [ ] Commands intuitive (consistent naming)
- [ ] Error messages helpful
- [ ] Output formatting clear
- [ ] Colours enhance readability (not hinder)
- [ ] Works in all terminals

### Code Quality Requirements
- [ ] 100% test coverage for new code
- [ ] All tests passing
- [ ] Type hints complete
- [ ] Docstrings complete (British English)

---

## Execution Checklist

### Pre-Implementation
- [ ] Create branch: `git checkout -b feature/v0.3.8-developer-experience-i`
- [ ] Use ux-architect agent for REPL design
- [ ] Design command reference
- [ ] Design debug output format

### Interactive Mode Implementation
- [ ] Add dependency: `prompt-toolkit>=3.0.0`
- [ ] Create `src/cli/interactive.py`
- [ ] Implement `InteractiveShell` class
- [ ] Core commands: add, query, list, show
- [ ] Configuration commands: set, get, show config, reset
- [ ] Session commands: save, load, history
- [ ] Tab completion
- [ ] Multi-line input
- [ ] Welcome message and help
- [ ] Unit tests
- [ ] UX testing

### Debug Mode Implementation
- [ ] Create `src/cli/debug.py`
- [ ] Implement `DebugLogger` class
- [ ] Instrument query pipeline
- [ ] Instrument retrieval steps
- [ ] Instrument generation step
- [ ] Formatted output
- [ ] CLI integration: `ragged query --debug`
- [ ] Unit tests
- [ ] Test on sample queries

### Testing & Validation
- [ ] Test all REPL commands
- [ ] Test session save/load
- [ ] Test configuration persistence
- [ ] Test debug mode on diverse queries
- [ ] Performance testing
- [ ] UX validation

### Documentation & Release
- [ ] Use documentation-architect agent
- [ ] Document interactive mode
- [ ] Document all REPL commands
- [ ] Document debug mode
- [ ] Add usage examples
- [ ] Run documentation-auditor agent
- [ ] Use git-documentation-committer agent
- [ ] Tag v0.3.8 release

---

## Dependencies

```toml
[tool.poetry.dependencies]
prompt-toolkit = "^3.0.0"     # BSD - Enhanced REPL with completion
```

---

## Agent Workflow (6-8h)

1. **ux-architect (2h):** REPL UX design and command structure validation
2. **documentation-architect (2h):** Command reference and user guides
3. **documentation-auditor (2-3h):** Comprehensive review
4. **git-documentation-committer (2-3h):** Commit

---

## Deliverables

1. **Interactive REPL** - Full-featured command-line interface
2. **Debug Mode** - Step-by-step pipeline visualisation
3. **Session Management** - Save/load state and history
4. **Tab Completion** - Enhanced discoverability
5. **Comprehensive Help** - Documentation at fingertips

---

## Success Criteria

- âœ… REPL launches and works smoothly
- âœ… All core commands functional
- âœ… Session state persists correctly
- âœ… Debug mode shows all pipeline steps clearly
- âœ… Tab completion enhances UX
- âœ… Performance overhead acceptable (<50ms per command)
- âœ… Help system comprehensive
- âœ… All tests passing, documentation complete

---

## Related Documentation

- [v0.3.0 Roadmap](./README.md) - Overview
- [v0.3.0 - Configuration Transparency](./v0.3.0.md) - Configuration system foundation

---

**Status:** Planned
