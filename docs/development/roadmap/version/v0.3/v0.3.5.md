# v0.3.5 - Modern Document Processing

**Category:** State-of-the-Art OCR & Document Intelligence

**Estimated Time:** 55-62 hours

**Status:** Planned

---

## Overview

**Architecture Change:** Replace Tesseract + Camelot with Docling + PaddleOCR for state-of-the-art document processing.

**Current Stack:** Tesseract (slow, poor table extraction) + Camelot (unreliable)
**New Stack:** Docling (primary, 30× faster) + PaddleOCR (fallback for messy docs)

**Performance Improvements:**
- **Speed:** 30× faster (1000 pages/min vs 100 pages/min)
- **Table Accuracy:** 97.9% (TableFormer) vs ~70% (Camelot)
- **Layout Preservation:** Excellent vs Poor
- **Multi-Modal:** Native support vs Hacked together

---

## Prerequisites

**Security & Privacy Foundation (REQUIRED):**

All v0.3.x versions depend on the security and privacy infrastructure established in v0.2.10 and v0.2.11. These versions MUST be completed before implementing any v0.3.x features.

- ✅ **v0.2.10 (Security Hardening)** - Eliminates Pickle vulnerabilities, implements session isolation, establishes security testing framework
- ✅ **v0.2.11 (Privacy Infrastructure)** - Provides encryption at rest, PII detection/redaction, data lifecycle management, GDPR compliance

**Why Required:** v0.3.x features will store and process user data (metrics, REPL history, API requests). The security and privacy foundations ensure this data is protected from the start.

---

## Features

### FEAT-007: Docling Primary Processor (15-18h)

**Priority:** Critical
**Dependencies:** None

#### Scope

Replace Tesseract + Camelot with Docling as the primary document processing engine.

**Docling Capabilities:**
- **Layout Analysis:** DocLayNet deep learning model understands document structure
- **Table Extraction:** TableFormer achieves 97.9% accuracy on complex tables
- **Reading Order:** Preserves logical document flow (important for context)
- **Formula Recognition:** Mathematical equations (when model available)
- **Born-Digital Optimisation:** Computer vision-based extraction (no OCR needed)
- **Scanned Document Support:** Built-in EasyOCR integration
- **Structured Output:** Clean Markdown + JSON for RAG pipelines

#### Performance

| Document Type | Docling Speed | Tesseract Speed | Improvement |
|---------------|---------------|-----------------|-------------|
| Born-digital PDF (100 pages) | 10s | 300s | 30× faster |
| Clean scan (100 pages) | 30s | 400s | 13× faster |
| Complex tables (10 pages) | 5s | 50s | 10× faster |

#### Implementation Overview

- **Module:** `src/processing/docling_processor.py`
- **Integration:** Replace existing `TesseractProcessor`
- **Migration:** Automatic fallback for old documents
- **Configuration:** Configurable via personas

#### Key Components

- `DoclingProcessor` class
- Layout analysis integration
- Table extraction (TableFormer)
- Reading order preservation
- Confidence tracking
- Structured output conversion (Docling JSON → ragged format)

---

### FEAT-008: PaddleOCR Fallback Engine (10-12h)

**Priority:** High
**Dependencies:** FEAT-007 (routing logic)

#### Scope

Implement PaddleOCR as fallback for worst-case messy documents where Docling struggles.

**Use Cases:**
- Heavily degraded scans
- Rotated/skewed documents
- Low-resolution images
- Handwritten notes
- Poor lighting/contrast

**PaddleOCR Advantages:**
- **Robustness:** Handles rotated/skewed text (slanted bounding boxes)
- **Quality Tolerance:** Works on poor-quality scans
- **Language Support:** 80+ languages
- **Handwriting:** Recognition capability
- **Privacy:** Fully offline, no external APIs
- **Performance:** Acceptable (slower than Docling but better than Tesseract on messy docs)

#### Routing Logic

```
Document → Docling processing
    ↓
Confidence score calculated
    ↓
Confidence >= 85%?
    → YES: Use Docling results
    → NO: Route to PaddleOCR
    ↓
PaddleOCR processing
    ↓
Return PaddleOCR results
```

#### Implementation Overview

- **Module:** `src/processing/paddleocr_processor.py`
- **Integration:** Fallback processor
- **Triggering:** Confidence-based routing
- **Languages:** Configurable, default English + common languages

#### Key Components

- `PaddleOCRProcessor` class
- Text detection (rotated bounding boxes)
- Text recognition (80+ languages)
- Confidence scoring
- Output normalisation (PaddleOCR format → ragged format)

---

### FEAT-019: Document Quality Assessment (8-10h)

**Priority:** High
**Dependencies:** FEAT-007, FEAT-008

#### Scope

Implement intelligent quality assessment to route documents to appropriate processors.

**Assessment Criteria:**
- Born-digital vs scanned detection
- Per-page quality scoring
- Confidence tracking per element
- Processor selection logic

#### Quality Scoring

```python
# Document quality factors
factors = {
    "is_born_digital": 1.0,      # Perfect quality
    "scan_quality": 0.95,         # DPI, contrast, etc.
    "text_clarity": 0.90,         # Character sharpness
    "layout_complexity": 0.85,    # Tables, columns, etc.
    "overall_confidence": weighted_average(factors)
}
```

#### Routing Thresholds

| Confidence | Action | Processor |
|-----------|--------|-----------|
| > 85% | Use primary results | Docling only |
| 70-85% | Validate and fallback if needed | Docling → PaddleOCR (selective) |
| < 70% | Use fallback | PaddleOCR directly |

#### Implementation Overview

- **Module:** `src/processing/quality_assessment.py`
- **Integration:** Pre-processing stage
- **Approach:** Heuristics + confidence scores from processors

#### Key Components

- `QualityAssessor` class
- Born-digital detection (PDF metadata, fonts)
- Scan quality scoring (DPI, contrast analysis)
- Confidence aggregation
- Routing decision logic

---

### FEAT-020: Vision Integration (7-8h)

**Priority:** Medium
**Dependencies:** FEAT-007

#### Scope

Integrate Docling's image extraction with existing Ollama llava vision model for image understanding.

**Current State:** llava generates image descriptions
**Enhancement:** Use Docling-extracted images with better quality

**Workflow:**
1. Docling extracts images from document
2. Images passed to llava
3. llava generates descriptions
4. Descriptions added to markdown output as alt-text

#### Implementation Overview

- **Module:** Modify existing `src/processing/vision_processor.py`
- **Integration:** Docling image extraction → llava
- **Output:** Enhanced markdown with image descriptions

#### Key Components

- Image extraction from Docling output
- llava integration (existing)
- Alt-text generation
- Markdown formatting with images

---

## Implementation Phases

### Phase 1: Architecture & Planning (8-10h)

**Sessions 1-2:**
- Use architecture-advisor agent for OCR stack review
- Study Docling API and capabilities
- Study PaddleOCR API
- Design routing logic
- Plan migration strategy from Tesseract

**Deliverables:**
- Architecture decision record (ADR) updated
- API integration plan documented
- Migration strategy defined

### Phase 2: Docling Integration (15-20h)

**Sessions 3-6:**
- Remove Tesseract and Camelot dependencies
- Add Docling dependencies
- Implement `DoclingProcessor` class
- Integrate layout analysis
- Integrate table extraction (TableFormer)
- Implement reading order preservation
- Output format conversion (Docling → ragged)
- Unit tests

**Deliverables:**
- Docling fully integrated
- Tesseract/Camelot removed
- Tests passing

### Phase 3: PaddleOCR Fallback (10-14h)

**Sessions 7-9:**
- Add PaddleOCR dependencies
- Implement `PaddleOCRProcessor` class
- Implement text detection (rotated support)
- Implement text recognition
- Output format normalisation
- Unit tests
- Integration with routing logic

**Deliverables:**
- PaddleOCR fallback functional
- Routing logic implemented
- Tests passing

### Phase 4: Quality Assessment & Routing (8-12h)

**Sessions 10-12:**
- Implement `QualityAssessor` class
- Born-digital detection
- Scan quality scoring
- Confidence aggregation
- Routing decision logic
- Integration tests for routing
- Performance testing

**Deliverables:**
- Quality assessment working
- Routing functional
- Performance benchmarks documented

### Phase 5: Vision Integration (7-10h)

**Sessions 13-14:**
- Modify vision processor for Docling images
- Test image extraction quality
- Test llava integration
- Validate alt-text generation
- Integration tests

**Deliverables:**
- Vision integration working
- Image descriptions improved

### Phase 6: Testing & Migration (6-8h)

**Sessions 15-16:**
- Test on diverse document types
- Performance benchmarking
- Migration testing (old vs new stack)
- Edge case testing
- Create migration guide

**Deliverables:**
- Comprehensive test results
- Migration guide complete
- Performance validated

### Phase 7: Documentation & Release (2-4h)

**Session 17:**
- Use documentation-architect agent
- Document new OCR stack
- Document routing logic
- Create migration guide for users
- Use documentation-auditor agent
- Use git-documentation-committer agent
- Tag v0.3.5 release

**Deliverables:**
- Complete documentation
- Migration guide published
- Release tagged

---

## Technical Architecture

### Module Structure

```
src/processing/
├── docling_processor.py        # Docling integration (300 lines)
│   └── class DoclingProcessor
├── paddleocr_processor.py      # PaddleOCR fallback (250 lines)
│   └── class PaddleOCRProcessor
├── quality_assessment.py       # Quality scoring (200 lines)
│   └── class QualityAssessor
├── processor_router.py         # Routing logic (150 lines)
│   └── class ProcessorRouter
├── vision_processor.py         # Vision integration (modified)
│   └── class VisionProcessor
└── base_processor.py           # Base interface (modified)

# REMOVED:
# ├── tesseract_processor.py    # Deleted
# ├── camelot_processor.py      # Deleted

tests/processing/
├── test_docling_processor.py
├── test_paddleocr_processor.py
├── test_quality_assessment.py
├── test_processor_router.py
└── test_integration.py
```

### Processing Pipeline Flow

```
PDF Document
    ↓
Quality Assessment
    ├─ is_born_digital? (check PDF metadata)
    ├─ scan_quality (DPI, contrast if scanned)
    ├─ confidence_score (aggregate)
    ↓
Processor Router
    ├─ High confidence (>85%) → Docling
    ├─ Medium confidence (70-85%) → Docling with validation
    └─ Low confidence (<70%) → PaddleOCR
    ↓
[Docling Path]
    ├─ Layout analysis (DocLayNet)
    ├─ Table extraction (TableFormer)
    ├─ Text extraction (computer vision or EasyOCR)
    ├─ Reading order preservation
    ├─ Image extraction → llava (optional)
    ├─ Confidence check → fallback if needed
    ↓
[PaddleOCR Path]
    ├─ Text detection (rotated boxes)
    ├─ Text recognition (80+ languages)
    ├─ Confidence scoring
    ↓
Output Normalisation
    ↓
Structured Markdown + JSON
```

### Configuration Integration

```python
# Persona-based processor preferences
personas = {
    "accuracy": {
        "primary_processor": "docling",
        "fallback_enabled": True,
        "confidence_threshold": 0.90,  # High threshold
        "vision_enabled": True
    },
    "speed": {
        "primary_processor": "docling",
        "fallback_enabled": False,  # Skip fallback
        "confidence_threshold": 0.75,  # Lower threshold
        "vision_enabled": False  # Skip vision
    },
    "balanced": {
        "primary_processor": "docling",
        "fallback_enabled": True,
        "confidence_threshold": 0.85,
        "vision_enabled": True
    }
}
```

---

## Risk Analysis & Mitigation

**Risk 1: Docling Dependency Stability**
- **Impact:** High - Core processing dependency
- **Probability:** Low - Mature project (IBM Research)
- **Mitigation:** Pin version, extensive testing, monitor releases, have PaddleOCR as fallback
- **Detection:** CI/CD integration tests

**Risk 2: PaddleOCR Performance on Large Batches**
- **Impact:** Medium - Slow processing for messy docs
- **Probability:** Medium - PaddleOCR is slower than Docling
- **Mitigation:** Only use for low-confidence docs, batch processing, async where possible, user expectations management
- **Detection:** Performance profiling

**Risk 3: Routing Logic Errors**
- **Impact:** High - Wrong processor selection degrades quality
- **Probability:** Medium - Threshold tuning is complex
- **Mitigation:** Extensive testing on diverse docs, configurable thresholds, logging for analysis
- **Detection:** Integration tests, user feedback

**Risk 4: Breaking Changes for Existing Users**
- **Impact:** Medium - Migration required
- **Probability:** High - Major architecture change
- **Mitigation:** Create migration guide, automatic re-processing option, clear communication
- **Detection:** User feedback, support requests

**Risk 5: Table Extraction Failures**
- **Impact:** Medium - Complex tables may fail
- **Probability:** Medium - Even 97.9% means 2.1% failure
- **Mitigation:** Validate table extraction, provide fallback formatting, user can manually correct
- **Detection:** Quality monitoring, user reports

---

## Quality Gates

### Functional Requirements
- [ ] Docling processes born-digital PDFs correctly
- [ ] Docling handles scanned PDFs with EasyOCR
- [ ] PaddleOCR fallback triggers on low confidence
- [ ] PaddleOCR handles rotated/skewed text
- [ ] Quality assessment detects born-digital vs scanned
- [ ] Routing logic selects correct processor
- [ ] Table extraction works (97%+ accuracy)
- [ ] Reading order preserved
- [ ] Vision integration extracts images correctly
- [ ] llava generates image descriptions

### Performance Requirements
- [ ] Born-digital PDFs: <1 sec/page
- [ ] Clean scans: 2-3 sec/page (Docling)
- [ ] Messy scans: 5-8 sec/page (PaddleOCR)
- [ ] Overall: 5× faster than Tesseract
- [ ] Memory usage acceptable (<2GB for 100-page doc)

### Quality Requirements
- [ ] Born-digital accuracy > 99%
- [ ] Clean scan accuracy > 98%
- [ ] Messy scan accuracy > 95%
- [ ] Table extraction accuracy > 97%
- [ ] Layout preservation accurate (manual validation)
- [ ] No quality regression vs Tesseract

### Code Quality Requirements
- [ ] 100% test coverage for new code
- [ ] All unit tests passing
- [ ] Integration tests for routing logic
- [ ] Performance tests passing
- [ ] Type hints complete
- [ ] Docstrings complete (British English)

---

## Execution Checklist

### Pre-Implementation
- [ ] Create feature branch: `git checkout -b feature/v0.3.5-modern-document-processing`
- [ ] Study Docling documentation and examples
- [ ] Study PaddleOCR documentation
- [ ] Use architecture-advisor agent for stack review
- [ ] Prepare test document corpus (born-digital, clean scans, messy scans, tables)

### Docling Integration
- [ ] Remove `pytesseract` and `camelot-py` from dependencies
- [ ] Add `docling = "^2.0.0"` to dependencies
- [ ] Add `opencv-python = "^4.8.0"` to dependencies
- [ ] Run `poetry install`
- [ ] Create `src/processing/docling_processor.py`
- [ ] Implement `DoclingProcessor` class
- [ ] Integrate DocLayNet layout analysis
- [ ] Integrate TableFormer table extraction
- [ ] Implement reading order preservation
- [ ] Implement output format conversion
- [ ] Unit tests
- [ ] Test on diverse document types

### PaddleOCR Fallback
- [ ] Add `paddleocr = "^2.8.0"` to dependencies
- [ ] Add `paddlepaddle = "^2.6.0"` to dependencies
- [ ] Run `poetry install`
- [ ] Create `src/processing/paddleocr_processor.py`
- [ ] Implement `PaddleOCRProcessor` class
- [ ] Implement text detection (rotated boxes)
- [ ] Implement text recognition
- [ ] Implement output normalisation
- [ ] Unit tests
- [ ] Test on messy documents

### Quality Assessment & Routing
- [ ] Create `src/processing/quality_assessment.py`
- [ ] Implement `QualityAssessor` class
- [ ] Implement born-digital detection
- [ ] Implement scan quality scoring
- [ ] Implement confidence aggregation
- [ ] Create `src/processing/processor_router.py`
- [ ] Implement routing logic
- [ ] Integration tests for routing
- [ ] Test threshold tuning

### Vision Integration
- [ ] Modify `src/processing/vision_processor.py`
- [ ] Integrate Docling image extraction
- [ ] Test llava integration
- [ ] Validate alt-text quality
- [ ] Integration tests

### Testing & Migration
- [ ] Test on 100+ diverse documents
- [ ] Performance benchmarking
- [ ] Compare Docling vs Tesseract quality
- [ ] Migration testing (reprocess old docs)
- [ ] Edge case testing
- [ ] Create migration guide

### Documentation & Release
- [ ] Use documentation-architect agent
- [ ] Document Docling integration
- [ ] Document PaddleOCR fallback
- [ ] Document routing logic
- [ ] Create user migration guide
- [ ] Add examples for different document types
- [ ] Run documentation-auditor agent
- [ ] Use git-documentation-committer agent
- [ ] Tag v0.3.5 release

### Post-Implementation
- [ ] Update implementation record
- [ ] Record actual hours vs estimate
- [ ] Document performance improvements
- [ ] Document quality improvements
- [ ] Document lessons learned
- [ ] Update v0.3/README.md progress

---

## Dependencies

### Removed (v0.3.5)
```toml
# pytesseract = "^0.3.10"      # Replaced by Docling
# camelot-py = "^0.11.0"       # Replaced by Docling TableFormer
```

### Added (v0.3.5)
```toml
docling = "^2.0.0"              # MIT - Primary processor
paddleocr = "^2.8.0"            # Apache 2.0 - Fallback OCR
paddlepaddle = "^2.6.0"         # Apache 2.0 - PaddleOCR backend
opencv-python = "^4.8.0"        # BSD - Image preprocessing
Pillow = "^10.0.0"              # HPND - Image handling (already present)
```

**All new dependencies are GPL-3.0 compatible (MIT, Apache 2.0, BSD, HPND)**

---

## Agent Workflow (12-14h)

1. **architecture-advisor (3h):** OCR architecture review and migration strategy
2. **documentation-architect (3h):** OCR pipeline documentation + user migration guide
3. **documentation-auditor (3-4h):** Comprehensive review
4. **git-documentation-committer (3-4h):** Commit with quality checks

---

## Deliverables

1. **Docling Integration** - Primary document processor with 30× speed improvement
2. **PaddleOCR Fallback** - Handles worst-case messy documents
3. **Quality Assessment** - Intelligent routing based on document quality
4. **Vision Integration** - Enhanced image extraction and description
5. **Migration Guide** - User documentation for transitioning from Tesseract
6. **Performance Improvement** - 5-30× faster processing confirmed

---

## Success Criteria

- ✅ Docling accuracy > 99% on born-digital PDFs
- ✅ Docling + PaddleOCR accuracy > 95% on messy scans
- ✅ Processing speed 5× faster than Tesseract (average)
- ✅ Table extraction accuracy > 97% (TableFormer)
- ✅ Layout preservation accurate
- ✅ Vision integration working correctly
- ✅ Migration guide complete
- ✅ All tests passing, documentation complete

---

## Related Documentation

- [Docling OCR Decision ADR](../../../decisions/2025-11-17-docling-ocr-decision.md) - Full decision rationale
- [v0.3.6 - Messy Document Intelligence](./v0.3.6.md) - Automated PDF correction (builds on this)
- [Multi-Modal Support Features](./features/multi-modal-support.md) - Detailed specifications

---

**Status:** Planned
