# v0.3.5 - Messy Document Intelligence

**Category:** Automated Document Correction & Exceptional Markdown (KILLER FEATURE)

**Estimated Time:** 49-57 hours

**Status:** Planned

---

## Overview

Fully automated messy PDF handling with exceptional markdown conversion - **completely hidden from users**.

**Killer Feature:** Users drop in any messy PDF (rotated pages, wrong order, duplicates, poor scans) and ragged automatically fixes everything behind the scenes. No user intervention required.

**User Experience:** `ragged add messy.pdf` → Just works™

---

## Prerequisites

**Security & Privacy Foundation (REQUIRED):**

All v0.3.x versions depend on the security and privacy infrastructure established in v0.2.10 and v0.2.11. These versions MUST be completed before implementing any v0.3.x features.

- ✅ **v0.2.10 (Security Hardening)** - Eliminates Pickle vulnerabilities, implements session isolation, establishes security testing framework
- ✅ **v0.2.11 (Privacy Infrastructure)** - Provides encryption at rest, PII detection/redaction, data lifecycle management, GDPR compliance

**Why Required:** v0.3.x features will store and process user data (metrics, REPL history, API requests). The security and privacy foundations ensure this data is protected from the start.

---

## Features

### FEAT-021: PDF Analysis & Detection (12-15h)

**Priority:** Critical
**Dependencies:** v0.3.0 (Docling integration)

#### Scope

Automatically detect and classify PDF issues requiring correction.

**Detection Capabilities:**
- **Rotation Detection:** Identify pages needing 90°/180°/270° rotation
- **Page Ordering:** Detect misordered pages via page numbers, headers, content flow
- **Duplicate Detection:** Find duplicate pages via content hashing
- **Missing Pages:** Detect gaps in page numbering
- **Quality Assessment:** Per-page OCR confidence scoring

#### Implementation Overview

- **Module:** `src/processing/pdf_analyzer.py`
- **Approach:** Multi-pass analysis with heuristics and ML
- **Integration:** Pre-processing stage before Docling

#### Key Components

- `PDFAnalyzer` class
- Rotation detection (text orientation analysis)
- Page order detection (page number extraction, content flow)
- Duplicate detection (perceptual hashing)
- Missing page detection (sequence analysis)
- Quality scoring per page

---

### FEAT-022: Automated PDF Correction (14-16h)

**Priority:** Critical
**Dependencies:** FEAT-021

#### Scope

Automatically correct all detected issues and store corrected PDF in library.

**Correction Operations:**
- **Auto-Rotate:** Fix pages based on text orientation (using pypdf)
- **Auto-Reorder:** Fix page sequence based on detected page numbers
- **Remove Duplicates:** Delete exact duplicate pages
- **Insert Placeholders:** Add blank pages for detected gaps with notice
- **Quality Enhancement:** Apply image preprocessing for poor scans

#### Storage Strategy

```
Original PDF:
  - Location: User's filesystem (external drive, Downloads, etc.)
  - Status: Untouched (never modified)
  - Purpose: User's original file

Corrected PDF:
  - Location: data/documents/corrected/<document_id>.pdf
  - Status: Automatically corrected
  - Purpose: Clean version for processing

Markdown:
  - Location: data/documents/markdown/<document_id>.md
  - Purpose: Extracted content with structure

Metadata:
  - Location: Database
  - Contents: Corrections applied, confidence scores, issues found
```

#### Implementation Overview

- **Module:** `src/processing/pdf_corrector.py`
- **Libraries:** pypdf (rotation, reordering), img2pdf (reconstruction)
- **Integration:** Post-analysis, pre-OCR stage

#### Key Components

- `PDFCorrector` class
- Page rotation (pypdf transformations)
- Page reordering (rebuild PDF with correct order)
- Duplicate removal (filter pages)
- Placeholder insertion (generate notice pages)
- Corrected PDF storage

---

### FEAT-023: Exceptional Markdown Conversion (6-7h)

**Priority:** High
**Dependencies:** FEAT-022, v0.3.0 (Docling)

#### Scope

Convert corrected PDFs to exceptional-quality markdown with rich structure preservation.

**Markdown Features:**
- **Document Structure:** Headings (H1-H6), lists (ordered/unordered), tables, footnotes
- **Figures & Captions:** Extract and link figures with captions
- **Equations:** Preserve LaTeX equations from Docling
- **Citations:** Detect and format citations
- **Page Markers:** `<!-- Page N -->` comments for reference
- **Confidence Tracking:** OCR confidence per section in metadata
- **Uncertainty Marking:** Low-confidence text marked as `[?unclear text?]`

#### Quality Targets

- **Default Quality:** "Good" (98%+ OCR confidence)
- **Markdown Compliance:** 100% valid markdown
- **Structure Preservation:** Headings, lists, tables correctly formatted
- **Link Preservation:** Internal links maintained

#### Implementation Overview

- **Module:** Enhance `src/processing/markdown_converter.py`
- **Approach:** Docling structured output → enhanced markdown
- **Integration:** Post-OCR conversion stage

#### Key Components

- Enhanced `MarkdownConverter` class
- Structure detection and formatting
- Figure and caption extraction
- LaTeX equation preservation
- Page marker insertion
- Confidence tracking
- Uncertainty annotation

---

## Implementation Phases

### Phase 1: Analysis & Design (8-10h)

**Sessions 1-2:**
- Use architecture-advisor agent for correction architecture
- Use ux-architect agent for markdown quality design
- Design PDF analysis algorithms
- Design correction strategies
- Plan storage architecture

**Deliverables:**
- Architecture documented
- Storage strategy finalized
- UX design validated

### Phase 2: PDF Analysis (12-16h)

**Sessions 3-5:**
- Implement `PDFAnalyzer` class
- Rotation detection algorithm
- Page order detection (page numbers, content flow)
- Duplicate detection (perceptual hashing)
- Missing page detection
- Quality scoring
- Unit tests

**Deliverables:**
- PDF analysis fully functional
- Tests passing
- Accurate detection validated

### Phase 3: Automated Correction (14-18h)

**Sessions 6-9:**
- Implement `PDFCorrector` class
- Page rotation logic (pypdf)
- Page reordering logic
- Duplicate removal
- Placeholder generation for missing pages
- Corrected PDF storage
- Metadata tracking
- Unit tests
- Integration tests

**Deliverables:**
- Automated correction working
- Corrected PDFs stored properly
- Metadata tracking functional

### Phase 4: Exceptional Markdown (6-8h)

**Sessions 10-11:**
- Enhance `MarkdownConverter` class
- Structure detection (headings, lists, tables)
- Figure and caption extraction
- LaTeX equation preservation
- Page marker insertion
- Confidence tracking
- Uncertainty marking
- Unit tests

**Deliverables:**
- Exceptional markdown quality achieved
- 98%+ confidence validated

### Phase 5: Integration & Testing (6-8h)

**Sessions 12-13:**
- Integrate full pipeline (analysis → correction → markdown)
- Test on diverse messy PDFs
- Performance benchmarking
- Edge case testing
- User experience validation

**Deliverables:**
- End-to-end pipeline working
- Performance acceptable
- UX validated

### Phase 6: Documentation & Release (3-5h)

**Session 14:**
- Use documentation-architect agent
- Document automated correction features
- Document markdown quality
- Create user guides
- Use documentation-auditor agent
- Use git-documentation-committer agent
- Tag v0.3.5 release

**Deliverables:**
- Complete documentation
- Release tagged

---

## Technical Architecture

### Module Structure

```
src/processing/
├── pdf_analyzer.py             # PDF analysis (300 lines)
│   └── class PDFAnalyzer
├── pdf_corrector.py            # Automated correction (350 lines)
│   └── class PDFCorrector
├── markdown_converter.py       # Enhanced markdown (modified, +200 lines)
│   └── class MarkdownConverter
└── correction_pipeline.py      # Orchestration (150 lines)
    └── class CorrectionPipeline

data/documents/
├── corrected/                  # Corrected PDFs
│   └── <document_id>.pdf
├── markdown/                   # Extracted markdown
│   └── <document_id>.md
└── metadata/                   # Correction metadata
    └── <document_id>_corrections.json

tests/processing/
├── test_pdf_analyzer.py
├── test_pdf_corrector.py
├── test_markdown_converter.py
└── test_correction_pipeline.py
```

### Processing Pipeline Flow

```
User: ragged add messy.pdf
    ↓
PDF Analysis (PDFAnalyzer)
    ├─ Detect rotation (text orientation analysis)
    ├─ Detect page order issues (page numbers, content flow)
    ├─ Detect duplicates (perceptual hashing)
    ├─ Detect missing pages (sequence analysis)
    └─ Quality scoring per page
    ↓
Issues Found? → Yes
    ↓
PDF Correction (PDFCorrector)
    ├─ Rotate pages (pypdf transformations)
    ├─ Reorder pages (rebuild PDF)
    ├─ Remove duplicates
    ├─ Insert placeholders for missing pages
    └─ Store corrected PDF (data/documents/corrected/)
    ↓
OCR Processing (Docling/PaddleOCR from v0.3.0)
    ├─ Process corrected PDF
    ├─ Extract text, tables, images
    └─ Generate structured output
    ↓
Exceptional Markdown Conversion
    ├─ Structure detection (headings, lists, tables)
    ├─ Figure and caption extraction
    ├─ LaTeX equation preservation
    ├─ Page markers insertion
    ├─ Confidence tracking
    └─ Uncertainty marking
    ↓
Store & Index
    ├─ Save markdown (data/documents/markdown/)
    ├─ Save metadata (corrections applied, confidence)
    ├─ Chunk and index for retrieval
    └─ Display success message to user

User sees:
✓ Added messy.pdf with 847 chunks (98% confidence)
```

### User Experience Examples

**Example 1: Messy Scanned Book**
```bash
$ ragged add scanned_textbook.pdf

Analysing scanned_textbook.pdf...
✓ Detected scanned document (287 pages)
✓ Found issues: 23 rotated pages, 4 duplicates, pages out of order
✓ Auto-correcting...
  • Rotated 23 pages
  • Removed 4 duplicate pages
  • Reordered 283 pages
✓ Processing with Docling... 98.2% confidence
✓ Converting to exceptional markdown...
✓ Added to library with 2,847 chunks

Corrections stored in metadata. Use --show-corrections to view.
```

**Example 2: Export Corrected PDF**
```bash
$ ragged export pdf scanned_textbook.pdf --corrected

Exporting corrected version...
✓ Exported to: scanned_textbook_corrected.pdf
```

**Example 3: View Corrections**
```bash
$ ragged show corrections scanned_textbook.pdf

Corrections Applied:
• Rotated pages: 2, 5, 7-15, 23-28 (90° clockwise)
• Removed duplicates: pages 45, 78, 123, 201
• Reordered: pages 100-150 (detected misordering)
• Inserted placeholders: page 67 (missing)

Quality: 98.2% OCR confidence (Good)
```

---

## Risk Analysis & Mitigation

**Risk 1: Incorrect Rotation Detection**
- **Impact:** High - Wrong rotation degrades OCR
- **Probability:** Medium - Heuristics can fail
- **Mitigation:** Multiple detection methods, confidence thresholds, user can review/override
- **Detection:** Manual validation, user feedback

**Risk 2: False Duplicate Detection**
- **Impact:** High - Removing non-duplicate pages loses content
- **Probability:** Low - Perceptual hashing is robust
- **Mitigation:** High similarity threshold (99%+), metadata logging, user can review
- **Detection:** Duplicate review feature

**Risk 3: Page Reordering Errors**
- **Impact:** High - Wrong order confuses context
- **Probability:** Medium - Page number detection can fail
- **Mitigation:** Conservative reordering (only when confident), metadata logging, user can disable
- **Detection:** Manual validation, user reports

**Risk 4: Storage Overhead (2× PDFs)**
- **Impact:** Medium - Disk space usage
- **Probability:** High - Storing original + corrected
- **Mitigation:** Acceptable trade-off, corrected PDFs compressible, user can delete corrected versions
- **Detection:** Disk usage monitoring

---

## Quality Gates

### Functional Requirements
- [ ] Rotation detection identifies rotated pages correctly
- [ ] Page order detection finds misordered pages
- [ ] Duplicate detection finds exact duplicates
- [ ] Missing page detection identifies gaps
- [ ] Automated rotation works (pypdf)
- [ ] Automated reordering works
- [ ] Duplicate removal works
- [ ] Placeholder insertion works
- [ ] Corrected PDFs stored correctly
- [ ] Exceptional markdown generated
- [ ] Structure preserved (headings, lists, tables)
- [ ] Confidence tracking accurate

### Performance Requirements
- [ ] PDF analysis <10s for 100-page document
- [ ] PDF correction <30s for 100-page document
- [ ] Markdown conversion <5s
- [ ] Total overhead <60s for typical messy PDF

### Quality Requirements
- [ ] Rotation detection accuracy > 95%
- [ ] Duplicate detection accuracy > 99%
- [ ] Page ordering accuracy > 90%
- [ ] Markdown quality: 98%+ OCR confidence
- [ ] Structure preservation: 95%+ accurate

### UX Requirements
- [ ] Fully automated (no user intervention)
- [ ] Clear progress messages
- [ ] Metadata accessible via CLI
- [ ] Corrected PDF exportable
- [ ] Original PDF never modified

### Code Quality Requirements
- [ ] 100% test coverage for new code
- [ ] All unit tests passing
- [ ] Integration tests for full pipeline
- [ ] Type hints complete
- [ ] Docstrings complete (British English)

---

## Execution Checklist

### Pre-Implementation
- [ ] Create feature branch: `git checkout -b feature/v0.3.5-messy-document-intelligence`
- [ ] Research PDF manipulation libraries
- [ ] Research page order detection algorithms
- [ ] Use architecture-advisor agent
- [ ] Use ux-architect agent for markdown quality

### PDF Analysis Implementation
- [ ] Create `src/processing/pdf_analyzer.py`
- [ ] Implement `PDFAnalyzer` class
- [ ] Implement rotation detection
- [ ] Implement page order detection
- [ ] Implement duplicate detection (perceptual hashing)
- [ ] Implement missing page detection
- [ ] Implement quality scoring
- [ ] Unit tests
- [ ] Test on diverse messy PDFs

### PDF Correction Implementation
- [ ] Add dependencies: `pypdf`, `img2pdf`, `scikit-image`
- [ ] Create `src/processing/pdf_corrector.py`
- [ ] Implement `PDFCorrector` class
- [ ] Implement page rotation (pypdf)
- [ ] Implement page reordering
- [ ] Implement duplicate removal
- [ ] Implement placeholder generation
- [ ] Implement corrected PDF storage
- [ ] Implement metadata tracking
- [ ] Unit tests
- [ ] Integration tests

### Exceptional Markdown Implementation
- [ ] Enhance `src/processing/markdown_converter.py`
- [ ] Implement structure detection
- [ ] Implement figure and caption extraction
- [ ] Implement LaTeX equation preservation
- [ ] Implement page marker insertion
- [ ] Implement confidence tracking
- [ ] Implement uncertainty marking
- [ ] Unit tests
- [ ] Validate markdown quality

### Integration & Testing
- [ ] Create `src/processing/correction_pipeline.py`
- [ ] Integrate analysis → correction → markdown pipeline
- [ ] Test on 50+ messy PDFs
- [ ] Performance benchmarking
- [ ] Edge case testing
- [ ] UX validation

### CLI Integration
- [ ] Add `--show-corrections` flag to `ragged show`
- [ ] Add `ragged export pdf --corrected` command
- [ ] Update `ragged add` output for corrections
- [ ] Test CLI commands

### Documentation & Release
- [ ] Use documentation-architect agent
- [ ] Document automated correction features
- [ ] Document exceptional markdown quality
- [ ] Document CLI commands
- [ ] Add examples and use cases
- [ ] Run documentation-auditor agent
- [ ] Use git-documentation-committer agent
- [ ] Tag v0.3.5 release

### Post-Implementation
- [ ] Update implementation record
- [ ] Record actual hours vs estimate
- [ ] Document correction accuracy metrics
- [ ] Document lessons learned
- [ ] Update v0.3/README.md progress

---

## Dependencies (Additional to v0.3.0)

```toml
pypdf = "^3.17.0"               # BSD - PDF manipulation (rotation, reordering)
img2pdf = "^0.5.1"              # LGPL - Image to PDF conversion
scikit-image = "^0.22.0"        # BSD - Image quality assessment
```

**All dependencies are GPL-3.0 compatible (BSD, LGPL)**

---

## Agent Workflow (14-16h)

1. **architecture-advisor (3h):** PDF correction architecture and storage strategy review
2. **ux-architect (2h):** Markdown quality design and user experience validation
3. **documentation-architect (4h):** User guides and pipeline documentation
4. **documentation-auditor (3-4h):** Comprehensive review
5. **git-documentation-committer (2-3h):** Commit with quality checks

---

## Deliverables

1. **Automated PDF Analysis** - Detects rotation, ordering, duplicates, missing pages
2. **Automated PDF Correction** - Fixes all detected issues automatically
3. **Corrected PDF Storage** - Stores clean versions in library
4. **Exceptional Markdown** - 98%+ confidence with rich structure
5. **Hidden UX** - Completely automatic, no user intervention
6. **Metadata Tracking** - All corrections logged and accessible

---

## Success Criteria

- ✅ Rotation detection accuracy > 95%
- ✅ Duplicate detection accuracy > 99%
- ✅ Page ordering accuracy > 90%
- ✅ Automated correction works on 95%+ of messy PDFs
- ✅ Exceptional markdown quality: 98%+ OCR confidence
- ✅ Structure preservation: 95%+ accurate
- ✅ Fully automated UX (no user intervention required)
- ✅ Original PDFs never modified
- ✅ All tests passing, documentation complete

---

## Related Documentation

- [v0.3.0 - Modern Document Processing](./v0.3.0.md) - Docling integration (foundation)
- [v0.3.0 Roadmap](./README.md) - Overview

---

**Status:** Planned
