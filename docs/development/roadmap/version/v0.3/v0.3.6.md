# v0.3.6 - VectorStore Abstraction

**Category:** API Foundation for v0.4 LEANN

**Estimated Time:** 16-22 hours

**Status:** Planned

---

## Overview

Create clean VectorStore abstraction to enable v0.4 LEANN integration without breaking changes.

**Strategic Importance:** This abstraction enables v0.4's LEANN (vector database) integration, allowing ragged to support multiple vector databases (Chroma, LEANN, Qdrant, Weaviate, etc.) with zero code changes.

**Design Principle:** Interface-driven design with current ChromaDB as reference implementation.

---

## Prerequisites

**Security & Privacy Foundation (REQUIRED):**

All v0.3.x versions depend on the security and privacy infrastructure established in v0.2.10 and v0.2.11. These versions MUST be completed before implementing any v0.3.x features.

- ✅ **v0.2.10 (Security Hardening)** - Eliminates Pickle vulnerabilities, implements session isolation, establishes security testing framework
- ✅ **v0.2.11 (Privacy Infrastructure)** - Provides encryption at rest, PII detection/redaction, data lifecycle management, GDPR compliance

**Why Required:** v0.3.x features will store and process user data (metrics, REPL history, API requests). The security and privacy foundations ensure this data is protected from the start.

---

## Features

### VectorStore Abstract Interface (4-6h)

**Priority:** Critical
**Dependencies:** None

#### Scope

Define standard interface that all vector databases must implement.

**Interface Methods:**
- `add_documents()` - Store documents with embeddings
- `query()` - Semantic search with filters
- `delete()` - Remove documents
- `update()` - Modify documents/metadata
- `list()` - List documents with pagination
- `get_stats()` - Database statistics

#### Implementation Overview

- **Module:** `src/storage/vectorstore_interface.py`
- **Approach:** Abstract base class with Protocol
- **Integration:** All existing code uses interface

---

### ChromaDB Refactor (4-6h)

**Priority:** Critical
**Dependencies:** VectorStore Interface

#### Scope

Refactor existing ChromaDB code to implement VectorStore interface.

**Current State:** Direct ChromaDB usage throughout codebase
**Target State:** ChromaDB as one implementation of VectorStore interface

#### Implementation Overview

- **Module:** `src/storage/chromadb_store.py`
- **Approach:** Implement VectorStore interface
- **Integration:** Zero breaking changes for existing code

---

## Implementation Phases

### Phase 1: Design (4-6h)

**Sessions 1-2:**
- Use architecture-advisor agent for abstraction design
- Design VectorStore interface methods
- Design metadata schema
- Design filter query syntax
- Plan migration path

**Deliverables:**
- Interface fully designed
- ADR created
- Migration strategy documented

### Phase 2: Implementation (8-12h)

**Sessions 3-4:**
- Create `VectorStore` abstract interface
- Refactor ChromaDB to use interface
- Update all call sites
- Unit tests
- Integration tests

**Deliverables:**
- Interface implemented
- ChromaDB refactored
- All tests passing

### Phase 3: Documentation & Release (4-6h)

**Session 5:**
- Use documentation-architect agent
- Document VectorStore interface
- Create ADR
- Use documentation-auditor agent
- Use git-documentation-committer agent
- Tag v0.3.6 release

**Deliverables:**
- Complete documentation
- Release tagged

---

## Technical Architecture

### Module Structure

```
src/storage/
├── vectorstore_interface.py    # Abstract interface (150 lines)
│   └── class VectorStore (ABC)
├── chromadb_store.py            # ChromaDB implementation (300 lines)
│   └── class ChromaDBStore(VectorStore)
└── vectorstore_factory.py       # Factory pattern (100 lines)
    └── get_vectorstore()
```

### VectorStore Interface

```python
from abc import ABC, abstractmethod
from typing import List, Dict, Any, Optional

class VectorStore(ABC):
    """Abstract interface for vector databases."""

    @abstractmethod
    def add_documents(
        self,
        documents: List[str],
        embeddings: List[List[float]],
        metadata: List[Dict[str, Any]],
        ids: Optional[List[str]] = None
    ) -> List[str]:
        """Add documents to vector store."""
        pass

    @abstractmethod
    def query(
        self,
        query_embedding: List[float],
        top_k: int = 5,
        filter: Optional[Dict[str, Any]] = None
    ) -> List[Dict[str, Any]]:
        """Semantic search."""
        pass

    @abstractmethod
    def delete(
        self,
        ids: Optional[List[str]] = None,
        filter: Optional[Dict[str, Any]] = None
    ) -> int:
        """Delete documents."""
        pass

    @abstractmethod
    def update(
        self,
        ids: List[str],
        metadata: Optional[List[Dict[str, Any]]] = None,
        documents: Optional[List[str]] = None
    ) -> int:
        """Update documents/metadata."""
        pass

    @abstractmethod
    def list(
        self,
        limit: int = 100,
        offset: int = 0,
        filter: Optional[Dict[str, Any]] = None
    ) -> List[Dict[str, Any]]:
        """List documents with pagination."""
        pass

    @abstractmethod
    def get_stats(self) -> Dict[str, Any]:
        """Get database statistics."""
        pass
```

---

## Risk Analysis & Mitigation

**Risk 1: Breaking Changes**
- **Impact:** High - Could break existing code
- **Probability:** Low - Careful refactoring
- **Mitigation:** Comprehensive tests, gradual migration, backwards compatibility layer
- **Detection:** CI/CD tests

**Risk 2: Performance Regression**
- **Impact:** Medium - Abstraction overhead
- **Probability:** Low - Minimal abstraction layer
- **Mitigation:** Benchmark before/after, optimise interface
- **Detection:** Performance tests

---

## Quality Gates

### Functional Requirements
- [ ] VectorStore interface complete
- [ ] ChromaDB implements all methods
- [ ] All existing code uses interface
- [ ] No breaking changes
- [ ] Factory pattern works

### Performance Requirements
- [ ] No performance regression (<5% overhead)

### Code Quality Requirements
- [ ] 100% test coverage
- [ ] Type hints complete
- [ ] Docstrings complete (British English)

---

## Execution Checklist

### Pre-Implementation
- [ ] Create branch: `git checkout -b feature/v0.3.6-vectorstore-abstraction`
- [ ] Use architecture-advisor agent
- [ ] Design interface methods

### Implementation
- [ ] Create `vectorstore_interface.py`
- [ ] Create `chromadb_store.py`
- [ ] Refactor existing code
- [ ] Create factory pattern
- [ ] Unit tests
- [ ] Integration tests

### Documentation & Release
- [ ] Create ADR
- [ ] Use documentation-architect agent
- [ ] Use documentation-auditor agent
- [ ] Use git-documentation-committer agent
- [ ] Tag v0.3.6 release

---

## Agent Workflow (6-8h)

1. **architecture-advisor (2h):** Abstraction design review
2. **documentation-architect (2h):** ADR creation and interface docs
3. **documentation-auditor (2-3h):** Comprehensive review
4. **git-documentation-committer (2-3h):** Commit

---

## Deliverables

1. **VectorStore Interface** - Abstract base class for all vector databases
2. **ChromaDB Implementation** - Reference implementation
3. **Factory Pattern** - Configurable database selection
4. **ADR** - Architecture decision documented
5. **Zero Breaking Changes** - Seamless migration

---

## Success Criteria

- ✅ VectorStore interface complete and documented
- ✅ ChromaDB refactored to use interface
- ✅ All existing tests passing
- ✅ No performance regression
- ✅ Ready for v0.4 LEANN integration
- ✅ Documentation complete

---

## Related Documentation

- [v0.3.0 Roadmap](./README.md) - Overview
- [v0.4.0 Planning](../../planning/version/v0.4/) - LEANN integration

---

**Status:** Planned
