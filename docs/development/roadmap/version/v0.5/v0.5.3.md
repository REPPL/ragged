# v0.5.3: CLI - Command-Line Interface

**Focus:** Comprehensive CLI exposing all vision features

**Hours:** 16-22 hours

**Dependencies:** v0.5.0 (ColPali + Dual Storage), v0.5.2 (Vision Retrieval)

**Status:** Planned

---

## Overview

Version 0.5.3 extends ragged's CLI to expose all v0.5 multi-modal features through an intuitive command-line interface. This version makes vision capabilities accessible to power users, automation scripts, and DevOps workflows.

**What This Version Delivers:**
- Enhanced `ingest` commands with vision embedding options
- Complete `query` command group (text, image, hybrid, interactive)
- `gpu` command group for device management and monitoring
- `storage` commands for schema migration and maintenance
- Progress indicators, verbose logging, and helpful error messages

**Why This Version is Critical:**
- Makes all vision features accessible without coding
- Enables automation and scripting of RAG workflows
- Provides GPU management and troubleshooting tools
- Maintains backward compatibility with v0.4.x CLI

**Builds On:** v0.5.0 foundation and v0.5.2 retrieval capabilities.

---

## Feature: VISION-005 Multi-Modal CLI Commands (16-22 hours)

### Command Structure

```
ragged/
├── ingest              # Document ingestion
│   ├── pdf             # PDF with optional vision embeddings
│   ├── batch           # Batch ingestion from directory
│   └── status          # Check ingestion progress
│
├── query               # Multi-modal queries
│   ├── text            # Text-only query (+ visual boosting)
│   ├── image           # Image-only query
│   ├── hybrid          # Text + image query
│   └── interactive     # Interactive query mode
│
├── gpu                 # GPU management
│   ├── list            # List available devices
│   ├── info            # Show device information
│   ├── stats           # Real-time memory statistics
│   └── benchmark       # Benchmark embedding generation
│
├── storage             # Storage management
│   ├── info            # Show storage statistics
│   ├── migrate         # Migrate v0.4 to v0.5 schema
│   └── vacuum          # Clean up orphaned embeddings
│
└── config              # Configuration management
    ├── show            # Display current configuration
    ├── set             # Set configuration value
    └── reset           # Reset to defaults
```

---

## Implementation Plan

### Phase 1: Ingestion Commands (5-7 hours)

**Session 1.1: Enhanced PDF Ingestion (3-4h)**

**New `ragged ingest pdf` Options:**
- `--vision/--no-vision` - Enable vision embeddings (default: False)
- `--device` - GPU device selection (cuda, mps, cpu, auto)
- `--batch-size` - Vision embedding batch size (default: adaptive)
- `--chunking` - Text chunking strategy (fixed, semantic, hierarchical)

**Example Usage:**
```bash
# Vision-enabled ingestion
ragged ingest pdf document.pdf --vision

# Specific GPU device
ragged ingest pdf document.pdf --vision --device cuda:1

# Custom batch size
ragged ingest pdf document.pdf --vision --batch-size 8
```

**Session 1.2: Batch Ingestion (2-3h)**

**New `ragged ingest batch` Command:**
- Batch ingest all PDFs from directory
- Recursive directory traversal option
- Pattern matching for file selection
- Progress tracking across multiple files

**Example Usage:**
```bash
# Batch ingest with vision
ragged ingest batch ./documents/ --vision --recursive

# Custom pattern
ragged ingest batch ./docs/ --pattern "report_*.pdf"
```

**Deliverables:**
- `src/cli/ingest.py` (~300 lines)
- Progress indicators for long operations
- Verbose logging option
- Error handling and recovery

**Time:** 5-7 hours

---

### Phase 2: Query Commands (4-6 hours)

**Session 2.1: Query Command Group (4-6h)**

**New Commands:**

**`ragged query text <QUERY>`**
- Text-only query with optional visual boosting
- Options: `--boost-diagrams`, `--boost-tables`, `--num-results`

**`ragged query image <IMAGE_PATH>`**
- Image-only visual similarity search
- Options: `--num-results`, `--device`

**`ragged query hybrid <TEXT> <IMAGE_PATH>`**
- Combined text + image query
- Options: `--text-weight`, `--vision-weight`, `--num-results`

**`ragged query interactive`**
- Interactive query mode with REPL interface
- Switch between text/image/hybrid modes
- View metadata, adjust weights dynamically

**Example Usage:**
```bash
# Text query with diagram preference
ragged query text "database schema" --boost-diagrams

# Image query
ragged query image architecture_sketch.png --num-results 5

# Hybrid query with custom weights
ragged query hybrid "auth flow" example.png --text-weight 0.6 --vision-weight 0.4
```

**Deliverables:**
- `src/cli/query.py` (~250 lines)
- Interactive query REPL
- Result formatting with metadata
- Execution time display

**Time:** 4-6 hours

---

### Phase 3: GPU & Storage Commands (4-6 hours)

**Session 3.1: GPU Management Commands (2-3h)**

**`ragged gpu list`**
- List all available GPU devices (CUDA, MPS, CPU)

**`ragged gpu info [DEVICE]`**
- Show detailed device information (name, memory, compute capability)

**`ragged gpu stats [DEVICE]`**
- Real-time memory statistics (allocated, reserved, free)
- Auto-refresh option for monitoring

**`ragged gpu benchmark`**
- Benchmark vision embedding generation
- Compare CUDA vs MPS vs CPU performance

**Example Usage:**
```bash
# List devices
ragged gpu list

# Show CUDA device info
ragged gpu info cuda:0

# Monitor memory in real-time
ragged gpu stats --watch
```

**Session 3.2: Storage Management Commands (2-3h)**

**`ragged storage info`**
- Show collection statistics (text/vision embedding counts)
- Storage size and schema version

**`ragged storage migrate`**
- Migrate v0.4 collections to v0.5 schema
- Dry-run mode for safety
- Progress tracking

**`ragged storage vacuum`**
- Clean up orphaned embeddings
- Reclaim disk space

**Example Usage:**
```bash
# Check storage stats
ragged storage info

# Dry-run migration
ragged storage migrate --dry-run

# Perform migration
ragged storage migrate --collection documents
```

**Deliverables:**
- `src/cli/gpu.py` (~200 lines)
- `src/cli/storage.py` (~150 lines)
- Real-time monitoring capabilities
- Safe migration workflows

**Time:** 4-6 hours

---

### Phase 4: Configuration & Testing (3-4 hours)

**Session 4.1: Configuration Commands (1-2h)**

**`ragged config show`**
- Display all configuration values
- Environment variable overrides highlighted

**`ragged config set <KEY> <VALUE>`**
- Update configuration value

**`ragged config reset`**
- Reset all configuration to defaults

**Session 4.2: Testing (2-3h)**

**Test Coverage:**
- All CLI commands functional
- Help text comprehensive and accurate
- Error messages clear and actionable
- Progress indicators work correctly
- Exit codes correct (0 = success, 1 = error)

**Deliverables:**
- `src/cli/config.py` (~100 lines)
- `tests/cli/test_commands.py` (~300 lines)
- Integration tests for CLI workflows

**Time:** 3-4 hours

---

## Implementation Checklist

- [ ] **Phase 1** (5-7h): Ingestion Commands
  - [ ] Enhanced `ingest pdf` with vision options
  - [ ] New `ingest batch` command
  - [ ] Progress indicators and logging

- [ ] **Phase 2** (4-6h): Query Commands
  - [ ] `query text` command
  - [ ] `query image` command
  - [ ] `query hybrid` command
  - [ ] `query interactive` REPL mode

- [ ] **Phase 3** (4-6h): GPU & Storage
  - [ ] `gpu list/info/stats/benchmark` commands
  - [ ] `storage info/migrate/vacuum` commands
  - [ ] Real-time monitoring

- [ ] **Phase 4** (3-4h): Config & Testing
  - [ ] `config show/set/reset` commands
  - [ ] Comprehensive CLI test suite
  - [ ] Integration tests

---

## Success Criteria

### Functional Requirements

- [ ] All ingestion commands work (pdf, batch, status)
- [ ] All query commands work (text, image, hybrid, interactive)
- [ ] All GPU commands work (list, info, stats, benchmark)
- [ ] All storage commands work (info, migrate, vacuum)
- [ ] Progress indicators display correctly
- [ ] Verbose logging option functional
- [ ] Error messages clear and helpful
- [ ] Help text comprehensive with examples

### Quality Standards

- [ ] All commands follow Click best practices
- [ ] British English in all help text and messages
- [ ] Exit codes correct (0 = success, 1+ = error)
- [ ] Backward compatible with v0.4.x CLI
- [ ] Test coverage: 80%+ for CLI module

### Performance

- [ ] Commands respond in <100ms (excluding actual work)
- [ ] Progress indicators update smoothly
- [ ] No blocking on user input (async where needed)

---

## Files Created/Modified

### New Files (~1,250 lines)

**Source Code:**
- `src/cli/ingest.py` (~300 lines)
- `src/cli/query.py` (~250 lines)
- `src/cli/gpu.py` (~200 lines)
- `src/cli/storage.py` (~150 lines)
- `src/cli/config.py` (~100 lines)

**Tests:**
- `tests/cli/test_ingest.py` (~100 lines)
- `tests/cli/test_query.py` (~100 lines)
- `tests/cli/test_gpu.py` (~50 lines)
- `tests/cli/test_storage.py` (~50 lines)
- `tests/cli/test_integration.py` (~150 lines)

### Modified Files

- `src/cli/__init__.py` (~50 lines) - Command registration

---

## Dependencies

**From Previous Versions:**
- v0.5.0: ColPaliEmbedder, DualEmbeddingStore
- v0.5.1: DeviceManager, MemoryMonitor (for GPU commands)
- v0.5.2: VisionRetriever (for query commands)
- click >= 8.0 (existing CLI framework)

**No New Dependencies**

---

## Example Workflows

### Workflow 1: Ingest and Query with Vision

```bash
# 1. Ingest PDF with vision embeddings
ragged ingest pdf research_paper.pdf --vision

# 2. Query by image
ragged query image architecture_diagram.png --num-results 5

# 3. Hybrid query
ragged query hybrid "neural architecture" diagram.png
```

### Workflow 2: Batch Processing and GPU Monitoring

```bash
# 1. Check available GPUs
ragged gpu list

# 2. Monitor GPU during batch ingestion
ragged gpu stats --watch &
ragged ingest batch ./documents/ --vision --device cuda:0
```

### Workflow 3: Schema Migration

```bash
# 1. Check current storage
ragged storage info

# 2. Dry-run migration
ragged storage migrate --dry-run

# 3. Perform migration
ragged storage migrate --collection documents
```

---

## Related Documentation

**Feature Implementation:**
- [VISION-005: CLI Commands](./features/VISION-005-cli-commands.md) - Complete implementation

**Dependencies:**
- [v0.5.0: ColPali + Dual Storage](./v0.5.0.md)
- [v0.5.2: Vision Retrieval](./v0.5.2.md)

**Context:**
- [v0.5.x Overview](./README.md)
- [Testing Specification](./testing.md)

**Next Steps:**
- [v0.5.4: Gradio Web UI](./v0.5.4.md) - Web interface alternative to CLI

---

**Status:** Planned - Ready for implementation
