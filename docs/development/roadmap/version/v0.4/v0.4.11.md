# v0.4.11 - Backend Migration & Selection Tools

**Hours**: 12-18 | **Priority**: P1 - Infrastructure | **Status**: Planned

**Dependencies**: v0.4.10 complete (Temporal memory system), v0.4.3 complete (LEANN backend available)

---

## Overview

Provide comprehensive tools for migrating between vector backends (ChromaDB ↔ LEANN), comparing backend performance, and selecting optimal backend for user needs.

**Vision**: Users can seamlessly migrate between backends based on their storage constraints, platform requirements, and performance needs—with confidence that data integrity is maintained.

**Rationale**: With LEANN (v0.4.3) offering 97% storage savings but platform-specific availability (macOS/Linux initially), users need robust migration and comparison tools to make informed backend decisions and safely switch backends when needed.

---

## Core Deliverables

### 1. Backend Migration Engine (6-8h)

Comprehensive migration system for moving vector data between backends.

#### Migration Architecture

```python
class BackendMigrator:
    """Migrate vector data between backends."""

    def migrate(
        self,
        source_backend: str,
        target_backend: str,
        persona: Optional[str] = None,
        batch_size: int = 100,
        verify: bool = True
    ) -> MigrationResult:
        """Migrate from source to target backend.

        Args:
            source_backend: "chromadb" or "leann"
            target_backend: "chromadb" or "leann"
            persona: Migrate specific persona (None = all)
            batch_size: Documents per batch
            verify: Verify migration integrity

        Returns:
            Migration result with statistics
        """
        # 1. Validate backends available
        self._validate_backends(source_backend, target_backend)

        # 2. Create backup
        backup_path = self._create_backup(source_backend, persona)

        # 3. Extract vectors from source
        vectors = self._extract_vectors(source_backend, persona, batch_size)

        # 4. Load vectors into target
        self._load_vectors(target_backend, vectors, batch_size)

        # 5. Verify migration (if enabled)
        if verify:
            verification = self._verify_migration(
                source_backend, target_backend, persona
            )
            if not verification.success:
                self._rollback(backup_path, target_backend)
                raise MigrationError(verification.errors)

        # 6. Update configuration
        self._update_backend_config(target_backend, persona)

        return MigrationResult(
            source=source_backend,
            target=target_backend,
            documents_migrated=len(vectors),
            personas_migrated=[persona] if persona else self._all_personas(),
            duration_seconds=...,
            verification=verification,
            backup_path=backup_path
        )
```

#### Features

**Batch Migration**:
- Process vectors in configurable batches
- Progress reporting
- Pause/resume capability (via checkpoints)
- Memory-efficient streaming

**Verification**:
```python
def _verify_migration(
    self,
    source: str,
    target: str,
    persona: Optional[str]
) -> VerificationResult:
    """Verify migration integrity.

    Checks:
    1. Document count matches
    2. Sample vector similarity (random 10%)
    3. Metadata preserved
    4. Query results consistent (sample queries)
    """
    pass
```

**Rollback**:
- Automatic rollback on verification failure
- Manual rollback command
- Backup preservation (configurable retention)

**Progress Reporting**:
```bash
$ ragged backend migrate chromadb leann

Migrating: ChromaDB → LEANN
Persona: researcher

[████████████░░░░░░░░] 60% (6,000/10,000 documents)
Elapsed: 2m 15s | ETA: 1m 30s
Batch 61/100 | Speed: 45 docs/sec
```

**Files**:
- `ragged/backend/migration.py` (~400 lines)
- `ragged/backend/verification.py` (~250 lines)
- `ragged/backend/rollback.py` (~150 lines)
- `tests/backend/test_migration.py` (~300 lines)

---

### 2. CLI Migration Commands (3-4h)

User-facing migration interface.

```bash
# ========================================
# Migration Commands
# ========================================

# Migrate all data to LEANN
ragged backend migrate chromadb leann \
  --verify \
  --backup \
  --batch-size 100

# Migrate specific persona
ragged backend migrate chromadb leann \
  --persona researcher \
  --verify

# Dry run (estimate time and storage)
ragged backend migrate chromadb leann \
  --dry-run

# Resume interrupted migration
ragged backend migrate chromadb leann \
  --resume \
  --checkpoint migration_20260315_143022.ckpt

# ========================================
# Verification Commands
# ========================================

# Verify existing backends match
ragged backend verify chromadb leann \
  --persona researcher \
  --sample-rate 0.1  # Verify 10% sample

# Full verification (all documents)
ragged backend verify chromadb leann --full

# ========================================
# Rollback Commands
# ========================================

# Rollback to backup
ragged backend rollback \
  --backup migration_backup_20260315.tar.gz \
  --confirm

# List available backups
ragged backend backups list

# Clean old backups
ragged backend backups clean --keep-latest 3

# ========================================
# Backend Selection
# ========================================

# Set default backend for persona
ragged backend set leann --persona researcher

# Set default backend globally
ragged backend set leann --global

# Show current backend
ragged backend current --persona researcher
```

**Files**:
- `ragged/cli/commands/backend.py` (~300 lines)
- `tests/cli/test_backend_commands.py` (~200 lines)

---

### 3. Backend Comparison Tools (3-4h)

Tools for comparing backend performance and characteristics.

#### Performance Benchmarking

```python
class BackendComparator:
    """Compare backend performance."""

    def benchmark(
        self,
        backends: List[str],
        operations: List[str] = None,
        corpus_size: int = 1000
    ) -> BenchmarkResults:
        """Benchmark backends against each other.

        Args:
            backends: List of backends to compare
            operations: ["ingest", "query", "batch_query", "storage"]
            corpus_size: Number of test documents

        Returns:
            Benchmark results for comparison
        """
        operations = operations or ["ingest", "query", "storage"]
        results = {}

        for backend in backends:
            results[backend] = {
                "ingest": self._benchmark_ingest(backend, corpus_size),
                "query": self._benchmark_query(backend, num_queries=100),
                "batch_query": self._benchmark_batch(backend, batch_size=10),
                "storage": self._measure_storage(backend, corpus_size)
            }

        return BenchmarkResults(results)
```

#### Comparison Metrics

**Ingest Performance**:
- Documents per second
- Memory usage during ingest
- Disk write patterns

**Query Performance**:
- Query latency (p50, p95, p99)
- Throughput (queries per second)
- Recall accuracy

**Storage Efficiency**:
- Disk space per document
- Compression ratio
- Total storage footprint

**CLI Comparison**:
```bash
# Benchmark both backends
ragged backend benchmark chromadb leann \
  --corpus-size 1000 \
  --queries 100

# Compare storage
ragged backend compare-storage chromadb leann

# Output:
Backend Storage Comparison (1,000 documents)

ChromaDB:
- Vector storage: 185 MB
- Metadata: 12 MB
- Total: 197 MB
- Per document: 202 KB

LEANN:
- Vector storage: 5.8 MB (97.0% savings)
- Metadata: 12 MB
- Total: 17.8 MB (91.0% savings)
- Per document: 18 KB

Recommendation: LEANN saves 179 MB (91% reduction)
```

**Files**:
- `ragged/backend/comparison.py` (~300 lines)
- `ragged/backend/benchmark.py` (~250 lines)
- `tests/backend/test_comparison.py` (~200 lines)

---

### 4. Platform Detection & Recommendations (2-3h)

Intelligent backend selection based on platform and user needs.

#### Platform Detection

```python
class BackendSelector:
    """Select optimal backend for platform."""

    def recommend_backend(
        self,
        storage_constraint: Optional[int] = None,  # MB
        platform_override: Optional[str] = None
    ) -> BackendRecommendation:
        """Recommend backend for user's platform.

        Args:
            storage_constraint: Max storage in MB (None = no limit)
            platform_override: Override platform detection

        Returns:
            Recommendation with reasoning
        """
        platform = platform_override or self._detect_platform()

        # Check LEANN availability
        leann_available = self._check_leann_available(platform)

        # Estimate storage needs
        current_docs = self._count_documents()
        estimated_storage = {
            "chromadb": current_docs * 200,  # ~200KB per doc
            "leann": current_docs * 20       # ~20KB per doc (90% savings)
        }

        # Make recommendation
        if not leann_available:
            return BackendRecommendation(
                backend="chromadb",
                reason="LEANN not available on platform",
                platform=platform,
                storage_estimate=estimated_storage["chromadb"]
            )

        if storage_constraint and estimated_storage["chromadb"] > storage_constraint:
            return BackendRecommendation(
                backend="leann",
                reason=f"Storage savings needed ({estimated_storage['leann']}MB vs {estimated_storage['chromadb']}MB)",
                platform=platform,
                storage_estimate=estimated_storage["leann"],
                storage_savings=estimated_storage["chromadb"] - estimated_storage["leann"]
            )

        # Default: ChromaDB for simplicity unless storage constrained
        return BackendRecommendation(
            backend="chromadb",
            reason="Default backend (adequate storage available)",
            platform=platform,
            storage_estimate=estimated_storage["chromadb"],
            alternative="leann",
            alternative_benefit=f"Switch to LEANN to save {estimated_storage['chromadb'] - estimated_storage['leann']}MB"
        )
```

**CLI Recommendations**:
```bash
# Get backend recommendation
ragged backend recommend

# Output:
Backend Recommendation

Platform: macOS (arm64)
Current documents: 8,500
LEANN available: Yes

Recommended: ChromaDB
Reason: Default backend (adequate storage available)

Current storage: 1.67 GB
Alternative (LEANN): 153 MB (saves 1.52 GB)

To switch to LEANN:
  ragged backend migrate chromadb leann

# With storage constraint
ragged backend recommend --max-storage 500

# Output:
Recommended: LEANN
Reason: Storage constraint (500 MB limit)
Estimated storage: 153 MB (within limit)
ChromaDB would need: 1.67 GB (exceeds limit)
```

**Files**:
- `ragged/backend/selector.py` (~200 lines)
- `ragged/backend/platform.py` (~100 lines)
- `tests/backend/test_selector.py` (~150 lines)

---

### 5. Migration Safety & Testing (2-3h)

Comprehensive safety measures and testing.

**Safety Measures**:

1. **Automatic Backups**:
   - Backup before migration (configurable)
   - Compressed tarball of source backend
   - Retention policy (keep last N backups)

2. **Verification**:
   - Document count matching
   - Vector similarity sampling (configurable rate)
   - Metadata preservation check
   - Query consistency validation

3. **Rollback**:
   - Automatic rollback on verification failure
   - Manual rollback capability
   - Backup restoration

4. **Checkpoints**:
   - Save progress during migration
   - Resume from checkpoint if interrupted
   - Checkpoint cleanup after success

**Testing Requirements**:

**Coverage**: ≥85% for migration modules

**Test Scenarios**:
- ✅ ChromaDB → LEANN migration
- ✅ LEANN → ChromaDB migration
- ✅ Partial migration (single persona)
- ✅ Migration verification
- ✅ Rollback on failure
- ✅ Resume from checkpoint
- ✅ Large corpus migration (>10K docs)
- ✅ Concurrent access during migration

**Test Files** (~850 lines):
- `tests/backend/test_migration.py` (~300 lines)
- `tests/backend/test_verification.py` (~200 lines)
- `tests/backend/test_rollback.py` (~150 lines)
- `tests/cli/test_backend_commands.py` (~200 lines)

---

## Documentation

**Required** (~1,000 lines):

1. **Guide**: Backend Migration Guide (~500 lines)
   - When to migrate
   - Migration process explained
   - Verification and rollback
   - Best practices
   - Troubleshooting

2. **Tutorial**: Switching Backends (~300 lines)
   - Step-by-step migration
   - Benchmarking backends
   - Choosing optimal backend
   - Real-world examples

3. **Reference**: Backend CLI Reference (~200 lines)
   - All migration commands
   - Configuration options
   - Platform compatibility matrix

---

## Success Criteria

Version 0.4.11 is successful if:

1. ✅ ChromaDB → LEANN migration works correctly
2. ✅ LEANN → ChromaDB migration works correctly
3. ✅ Migration verification catches data inconsistencies
4. ✅ Automatic rollback works on failure
5. ✅ Backup and restore functional
6. ✅ Checkpoint/resume works for interrupted migrations
7. ✅ Backend comparison provides accurate metrics
8. ✅ Platform detection correct (macOS, Linux, Windows)
9. ✅ Recommendations sensible based on constraints
10. ✅ Large corpus migrations complete successfully (>10K docs)
11. ✅ Performance acceptable (see targets below)
12. ✅ 85%+ test coverage
13. ✅ Documentation complete
14. ✅ Zero data loss in migrations

---

## Performance Targets

- Migration speed: >50 documents/second
- Large corpus migration (10K docs): <5 minutes
- Verification sampling (10%): <30 seconds
- Backup creation: <2 minutes for 10K docs
- Rollback: <3 minutes
- Platform detection: <100ms
- Storage comparison calculation: <1s

---

## File Summary

**New Files** (~2,800 lines):
- Migration core: ~1,200 lines
- CLI: ~300 lines
- Comparison & selection: ~650 lines
- Tests: ~850 lines
- Documentation: ~1,000 lines

**Dependencies**:
- No new external dependencies
- Uses existing VectorStore interface (v0.4.2)
- Requires both ChromaDB and LEANN backends available

---

## Migration Workflow

**Safe Migration Process**:

1. **Pre-Migration**:
   ```bash
   # Check current backend and storage
   ragged backend current
   ragged backend storage-info

   # Get recommendation
   ragged backend recommend

   # Benchmark (optional)
   ragged backend benchmark chromadb leann --corpus-size 1000
   ```

2. **Migration**:
   ```bash
   # Dry run first
   ragged backend migrate chromadb leann --dry-run

   # Actual migration with verification
   ragged backend migrate chromadb leann --verify --backup
   ```

3. **Post-Migration**:
   ```bash
   # Verify migration
   ragged backend verify chromadb leann --full

   # Test queries
   ragged query "test query" --persona researcher

   # Check storage savings
   ragged backend storage-info
   ```

4. **Cleanup** (after confidence in migration):
   ```bash
   # Remove old backend data (optional)
   ragged backend cleanup chromadb --confirm

   # Keep backups or clean old ones
   ragged backend backups clean --keep-latest 1
   ```

---

## Configuration

**Migration Config** (`~/.ragged/config/backend.yaml`):
```yaml
migration:
  # Backup settings
  auto_backup: true
  backup_retention: 3  # Keep last 3 backups
  backup_compression: "gzip"

  # Verification settings
  auto_verify: true
  verification_sample_rate: 0.1  # Verify 10% of documents
  full_verify_threshold: 1000  # Full verify if <1000 docs

  # Performance settings
  batch_size: 100
  checkpoint_interval: 1000  # Checkpoint every 1000 docs
  parallel_batches: 2

  # Safety settings
  auto_rollback: true  # Rollback on verification failure
  require_confirmation: true  # Confirm destructive operations
```

---

## Risk Assessment

**Medium Risk**:
- Data loss during migration → Mitigation: Automatic backups, verification, rollback
- Performance degradation during migration → Mitigation: Batch processing, checkpoints
- Platform detection errors → Mitigation: Override option, comprehensive testing

**Low Risk**:
- Backend comparison accuracy (straightforward metrics)
- Storage calculations (deterministic)

---

## Platform Compatibility Matrix

| Platform | ChromaDB | LEANN | Notes |
|----------|----------|-------|-------|
| macOS (Intel) | ✅ | ✅ | LEANN fully supported |
| macOS (Apple Silicon) | ✅ | ✅ | LEANN fully supported |
| Linux (x86_64) | ✅ | ✅ | LEANN fully supported |
| Linux (ARM) | ✅ | ⚠️ | LEANN: Build from source |
| Windows 10/11 | ✅ | ❌ | LEANN: Future support (v0.5.x) |
| Docker (Linux) | ✅ | ✅ | LEANN available in containers |

**Legend**:
- ✅ Fully supported
- ⚠️ Supported with manual setup
- ❌ Not yet supported

---

## Use Cases

**Use Case 1: Storage-Constrained User**
- Situation: User has 50K documents, storage reaching limits
- Solution: Migrate to LEANN, save 90% storage
- Command: `ragged backend migrate chromadb leann --verify`

**Use Case 2: Platform Migration**
- Situation: User switches from macOS to Windows
- Solution: Migrate from LEANN to ChromaDB (Windows compatibility)
- Command: `ragged backend migrate leann chromadb --verify`

**Use Case 3: Performance Optimisation**
- Situation: User wants fastest query performance
- Solution: Benchmark backends, choose best for workload
- Command: `ragged backend benchmark chromadb leann`

**Use Case 4: Testing Backend**
- Situation: User wants to try LEANN without commitment
- Solution: Migrate with backup, test, rollback if needed
- Command: `ragged backend migrate chromadb leann --backup`

---

## Related Documentation

- [v0.4 Overview](README.md) - Release series overview
- [v0.4.2](v0.4.2.md) - VectorStore abstraction (foundation for multi-backend)
- [v0.4.3/README.md](v0.4.3/README.md) - LEANN backend implementation
- [v0.4.10](v0.4.10/README.md) - Temporal memory (previous)
- [v0.4.12](v0.4.12.md) - Performance optimisation (next)

---
