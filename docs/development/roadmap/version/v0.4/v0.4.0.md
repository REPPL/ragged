# v0.4.0 - Plugin Architecture & Testing Foundation

**Hours**: 25-30 | **Priority**: P0 - Foundation | **Status**: Planned

**Dependencies**: v0.3.x complete

---

## Overview

Establish the architectural foundation for v0.4.x with a complete plugin system and comprehensive testing infrastructure achieving 80%+ coverage from day one.

**Vision**: Build extensibility and quality infrastructure that enables safe, rapid development of memory features in subsequent releases.

**Note on v0.3.13 REST API**: The plugin system (v0.4.0) and REST API (v0.3.13) are **complementary, not competing** extension mechanisms:
- **REST API** (v0.3.13): HTTP interface for external applications to query ragged
- **Plugin System** (v0.4.0): Internal extensibility for custom embedders, retrievers, processors, commands
- **Coexistence**: Both work together; REST API can expose plugin-enhanced functionality

---

## Core Deliverables

### 1. Plugin Architecture System (20-25h)

Complete implementation of 4 plugin types with discovery, loading, and management.

#### Plugin Interfaces (6-8h)
- **EmbedderPlugin**: Custom embedding models
- **RetrieverPlugin**: Custom retrieval strategies
- **ProcessorPlugin**: Custom document processors
- **CommandPlugin**: Custom CLI commands

**Files**:
- `ragged/plugins/interfaces.py` (~400 lines)
- `ragged/plugins/exceptions.py` (~100 lines)

#### Plugin Discovery & Loading (5-7h)
- Entry point discovery
- Safe loading with validation
- Resource management

**Files**:
- `ragged/plugins/loader.py` (~250 lines)
- `ragged/plugins/validator.py` (~150 lines)

#### Plugin Registry & Management (4-6h)
- Central plugin registry
- Lifecycle management
- Configuration persistence

**Files**:
- `ragged/plugins/manager.py` (~300 lines)
- `ragged/plugins/registry.py` (~200 lines)
- `ragged/config/plugin_schema.py` (~100 lines)

#### CLI Commands (5-6h)
```bash
ragged plugin list [--installed] [--type TYPE]
ragged plugin install PLUGIN [--type TYPE]
ragged plugin enable PLUGIN
ragged plugin disable PLUGIN
ragged plugin config PLUGIN [--set KEY=VALUE] [--file CONFIG]
ragged plugin info PLUGIN
ragged plugin uninstall PLUGIN --confirm
```

**Files**:
- `ragged/cli/commands/plugin.py` (~350 lines)

---

### 2. Testing Infrastructure (5h)

Upgrade testing to support 80%+ coverage requirement with comprehensive fixtures and quality gates.

#### Test Coverage Tooling (1h)
- Configure pytest-cov for 80% minimum
- Coverage reporting in CI/CD
- Coverage badges

#### Test Fixtures & Factories (2h)
- Plugin testing fixtures
- Sample plugin implementations
- Mock backends

#### Integration Test Suite (1h)
- Plugin loading end-to-end
- Multi-plugin interactions
- Configuration persistence

#### CI/CD Quality Gates Configuration (1h)

**Goal**: Establish automated quality enforcement that prevents regressions throughout v0.4.x series.

**pytest-cov Configuration** (`pyproject.toml`):
```toml
[tool.pytest.ini_options]
addopts = [
    "--cov=src",
    "--cov-report=html",
    "--cov-report=term",
    "--cov-fail-under=80",
    "--strict-markers",
]
```

**Pre-Commit Hooks** (`.pre-commit-config.yaml`):
```yaml
repos:
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.1.0
    hooks:
      - id: ruff
        args: [--fix, --exit-non-zero-on-fix]
      - id: ruff-format

  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.7.0
    hooks:
      - id: mypy
        args: [--strict, --python-version=3.12]

  - repo: https://github.com/PyCQA/bandit
    rev: 1.7.5
    hooks:
      - id: bandit
        args: [-c, pyproject.toml]
```

**GitHub Actions Quality Check** (`.github/workflows/quality.yml`):
```yaml
name: Quality Gates

on: [push, pull_request]

jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install -e ".[dev]"
          pip install pytest-cov mypy ruff bandit

      - name: Run tests with coverage
        run: pytest --cov=src --cov-fail-under=80

      - name: Type checking
        run: mypy src --strict

      - name: Linting
        run: ruff check src tests

      - name: Security scan
        run: bandit -r src -c pyproject.toml

      - name: Upload coverage
        uses: codecov/codecov-action@v3
```

**Quality Gate Enforcement**:
- ✅ All tests must pass
- ✅ Coverage ≥80% (hard failure)
- ✅ Type checking: 0 errors (mypy strict mode)
- ✅ Linting: 0 errors, <10 warnings (ruff)
- ✅ Security: No high/critical vulnerabilities (bandit)
- ✅ Performance: No regression >5% (benchmarks in v0.4.0+)

---

## Testing Requirements

**Coverage Targets**:
- Overall: ≥80%
- Plugin module: ≥90%
- Critical paths: 100%

**Test Files** (~1,400 lines):
- `tests/plugins/test_interfaces.py` (~250 lines)
- `tests/plugins/test_loader.py` (~150 lines)
- `tests/plugins/test_manager.py` (~200 lines)
- `tests/plugins/test_registry.py` (~100 lines)
- `tests/plugins/fixtures/` (4 sample plugins × 100 lines)
- `tests/cli/test_plugin_commands.py` (~200 lines)
- `tests/conftest.py` additions (~100 lines)

**Quality Checks**:
- ✅ All abstract methods enforce implementation
- ✅ Type hints complete
- ✅ Plugin discovery works
- ✅ CLI commands functional
- ✅ Security validation present

---

## Documentation

**Required** (~2,500 lines):

1. **Tutorial**: "Creating Your First Plugin" (~500 lines)
   - Quick start guide
   - Step-by-step embedder plugin
   - Testing and publishing

2. **Guide**: "Plugin Development Guide" (~800 lines)
   - Complete interface documentation
   - All four plugin types
   - Security guidelines
   - Testing strategies

3. **Reference**: "Plugin API Documentation" (~600 lines)
   - Complete API reference
   - Method signatures
   - Configuration schema
   - Lifecycle hooks

4. **Examples**: Sample plugins (~600 lines)
   - Custom embedder (Hugging Face)
   - Custom retriever (hybrid variation)
   - Custom processor (LaTeX)
   - Custom command (batch analysis)

---

## Success Criteria

Version 0.4.1 is successful if:

1. ✅ Plugin system fully functional with all 4 types
2. ✅ 80%+ test coverage achieved and enforced
3. ✅ CI/CD quality gates preventing regressions
4. ✅ Plugin discovery via entry points works
5. ✅ Sample plugins demonstrate all interfaces
6. ✅ CLI commands functional with rich output
7. ✅ Documentation complete with examples
8. ✅ Zero breaking changes
9. ✅ Performance: Plugin loading <100ms, discovery <500ms
10. ✅ Type safety: mypy strict mode passes

---

## Performance Targets

- Plugin loading: <100ms per plugin
- Plugin discovery: <500ms for all types
- Configuration loading: <50ms
- Abstraction overhead: <1ms per call

---

## File Summary

**New Files** (~3,950 lines):
- Plugin core: ~1,550 lines
- CLI: ~350 lines
- Tests: ~1,400 lines
- Documentation: ~2,500 lines
- Examples: ~600 lines

**Modified Files**:
- `ragged/cli/main.py` - Register plugin commands
- `tests/conftest.py` - Plugin fixtures
- `pyproject.toml` - Coverage config, entry points
- `.github/workflows/test.yml` - Quality gates

---

## Risk Assessment

**Medium Risk**:
- Entry point discovery failures → Mitigation: Extensive testing
- Platform-specific issues → Mitigation: CI on macOS/Linux/Windows

**Low Risk**:
- Plugin validation (established patterns)
- Configuration management (simple YAML)

---

## Related Documentation

- [v0.4.0 Overview](README.md) - Release series overview
- [v0.4 Detailed Spec](v0.4-detailed-spec.md) - Part 7: Plugin Architecture
- [v0.4.0](v0.4.0.md) - VectorStore abstraction (next)
- [CLI Enhancements Catalogue](../../../planning/interfaces/cli/enhancements.md)

---
