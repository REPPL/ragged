# v0.4.0 - Plugin Sandboxing & Security Foundation

**Hours**: 8-10 | **Priority**: P0 - Critical Foundation | **Status**: Planned

**Dependencies**: v0.3.x series complete

---

## Overview

Establish security baseline for ragged's plugin ecosystem by implementing sandboxing, permissions, and audit logging **before** introducing plugin functionality (v0.4.1).

**Vision**: Security-first approach - ensure plugins cannot compromise user privacy or system security.

**Rationale**: This release extracts security foundation from the original v0.4.1 (Plugin Architecture) to ensure sandboxing is in place **before** any plugin code runs. Demonstrates ragged's commitment to privacy-first development.

---

## Core Deliverables

### 1. Plugin Sandboxing Framework (3-4h)

Process isolation and resource limits for plugins.

#### Security Boundaries

**Sandboxing Mechanisms**:
- Process isolation (separate process per plugin)
- File system restrictions (read-only access to ragged data)
- Network access controls (explicit permissions required)
- Memory limits (configurable per plugin type)
- CPU time limits (prevent runaway plugins)

**Implementation**:
```python
class PluginSandbox:
    """Isolated execution environment for plugins."""

    def execute(self, plugin_code: str, permissions: PluginPermissions):
        """Execute plugin in sandboxed environment."""
        # Separate process
        # Resource limits
        # Permission enforcement
        pass
```

**Files**:
- `ragged/plugins/sandbox.py` (~200 lines)
- `ragged/plugins/process_isolation.py` (~150 lines)
- `tests/plugins/test_sandbox.py` (~200 lines)

---

### 2. Permission System (2-3h)

Fine-grained permission model for plugin capabilities.

#### Permission Types

**File System Permissions**:
- `read:documents` - Read document content
- `write:documents` - Modify documents (restricted)
- `read:config` - Read configuration
- `write:config` - Modify configuration (high risk)

**Network Permissions**:
- `network:none` - No network access (default)
- `network:api` - External API calls (requires explicit consent)
- `network:download` - Download resources

**System Permissions**:
- `system:embedding` - Access embedding models
- `system:vectorstore` - Query vector database
- `system:memory` - Access memory system (v0.4.5+)

#### Permission Declaration

```toml
# Plugin manifest (plugin.toml)
[permissions]
required = ["read:documents", "system:embedding"]
optional = ["network:api"]
```

**User Consent**:
- First run: User approves required permissions
- Optional permissions: Requested on-demand
- Deny by default (explicit opt-in required)

**Files**:
- `ragged/plugins/permissions.py` (~150 lines)
- `ragged/plugins/consent.py` (~100 lines)
- `tests/plugins/test_permissions.py` (~150 lines)

---

### 3. Audit Logging (2h)

Comprehensive logging of all plugin actions.

#### Logged Events

**Plugin Lifecycle**:
- Plugin loaded
- Permissions requested/granted/denied
- Plugin executed
- Plugin failed/crashed

**Security Events**:
- Permission violations attempted
- Sandbox escapes attempted (if detected)
- Unexpected network calls
- File system access attempts

**Privacy Events**:
- Document access (read/write)
- Memory system access (future v0.4.5)
- Configuration changes

#### Audit Log Format

```json
{
  "timestamp": "2026-03-15T10:30:45Z",
  "event": "plugin_executed",
  "plugin": "custom-embedder",
  "version": "1.2.0",
  "permissions_used": ["read:documents", "system:embedding"],
  "result": "success",
  "duration_ms": 245,
  "user_id": "researcher"
}
```

**Files**:
- `ragged/plugins/audit.py` (~100 lines)
- `ragged/cli/audit_log.py` (~80 lines) - View audit logs
- `tests/plugins/test_audit.py` (~100 lines)

---

### 4. Security Validation Framework (1-2h)

Automated security checks for plugins.

#### Validation Checks

**Static Analysis**:
- Code scanning for dangerous patterns
- Dependency vulnerability scanning
- Permission usage validation

**Runtime Monitoring**:
- Resource usage tracking
- Permission violation detection
- Unexpected behaviour detection

**Files**:
- `ragged/plugins/validation.py` (~120 lines)
- `tests/plugins/test_validation.py` (~100 lines)

---

### 5. CLI Security Commands (1h)

User-facing security management.

```bash
# View plugin permissions
ragged plugin permissions <plugin-name>

# Revoke permissions
ragged plugin revoke <plugin-name> --permission read:documents

# View audit log
ragged audit show --plugin <name> --since "-7d"

# Security report
ragged security report --plugins
```

**Files**:
- Update `ragged/cli/main.py` with security commands
- `tests/cli/test_security_commands.py` (~100 lines)

---

## Testing Requirements

**Coverage**: ≥90% for security modules (higher than standard 80%)

**Security Tests**:
- ✅ Sandbox prevents file system escapes
- ✅ Sandbox prevents network access without permission
- ✅ Permission system enforces denials correctly
- ✅ Audit logging captures all security events
- ✅ Validation detects dangerous patterns
- ✅ Resource limits enforced (memory, CPU)
- ✅ User consent required for permissions

**Test Files** (~650 lines):
- `tests/plugins/test_sandbox.py` (~200 lines)
- `tests/plugins/test_permissions.py` (~150 lines)
- `tests/plugins/test_audit.py` (~100 lines)
- `tests/plugins/test_validation.py` (~100 lines)
- `tests/cli/test_security_commands.py` (~100 lines)

---

## Documentation

**Required** (~800 lines):

1. **Guide**: Plugin Security Model (~400 lines)
   - Sandboxing architecture
   - Permission model explained
   - User consent workflow
   - Audit logging overview

2. **Reference**: Security API (~200 lines)
   - Permission types reference
   - Audit log format specification
   - Validation rules

3. **Guide**: Security Best Practices for Plugin Developers (~200 lines)
   - Minimal permissions principle
   - Handling permission denials
   - Security testing guidelines

---

## Success Criteria

Version 0.4.0 is successful if:

1. ✅ Plugin sandboxing prevents file system escapes
2. ✅ Plugin sandboxing prevents unauthorised network access
3. ✅ Permission system enforces all denials correctly
4. ✅ Audit logging captures 100% of security events
5. ✅ Validation detects common dangerous patterns
6. ✅ Resource limits enforced (memory <500MB per plugin, CPU <10s)
7. ✅ 90%+ test coverage for security modules
8. ✅ Security documentation complete
9. ✅ No critical security findings in testing
10. ✅ User consent workflow intuitive and clear

---

## Performance Targets

- Sandbox initialisation: <100ms
- Permission check: <1ms
- Audit log write: <10ms (async)
- Validation scan: <500ms (on plugin load)

---

## File Summary

**New Files** (~1,600 lines):
- Security core: ~720 lines
- Tests: ~650 lines
- Documentation: ~800 lines
- CLI: ~80 lines (new commands)

**Dependencies**:
- Python standard library (subprocess, multiprocessing)
- No new external dependencies

---

## Security Architecture

```
Plugin Execution Flow:
1. User installs plugin
2. Validation scan (static analysis)
3. User reviews permissions
4. User grants/denies permissions
5. Plugin loaded into sandbox
6. Plugin executed with enforced permissions
7. All actions logged to audit log
8. Sandbox cleaned up after execution
```

**Sandbox Isolation**:
```
┌─────────────────────────────────────┐
│ Ragged Main Process                 │
│                                     │
│  ┌──────────────────────────────┐  │
│  │ Plugin Sandbox (isolated)    │  │
│  │ - Separate process           │  │
│  │ - Resource limits            │  │
│  │ - File system restrictions   │  │
│  │ - Network controls           │  │
│  │ - Permission enforcement     │  │
│  └──────────────────────────────┘  │
│                                     │
│  Audit Log ◄─────────────────────  │
└─────────────────────────────────────┘
```

---

## Risk Assessment

**Critical Importance**:
- This is the **security foundation** for the entire plugin ecosystem
- Failure means plugins could compromise user privacy or system security
- Must be thorough and battle-tested before v0.4.1

**Mitigation**:
- 90%+ test coverage requirement (higher than standard)
- Comprehensive security testing scenarios
- Automated validation on every plugin load
- User consent required for all permissions
- Audit logging for forensics

---

## Integration with v0.4.1

**v0.4.1 (Plugin Architecture) inherits**:
- Sandbox framework (all plugins run in sandbox)
- Permission system (all plugins declare permissions)
- Audit logging (all plugin actions logged)
- Validation framework (all plugins validated)

**Dependency Flow**:
```
v0.4.0 (Security Foundation)
    ↓
v0.4.1 (Plugin Architecture - uses security foundation)
    ↓
v0.4.x (All plugins benefit from security baseline)
```

---

## Related Documentation

- [v0.4 Overview](README.md) - Release series overview
- [v0.4.1](v0.4.1.md) - Plugin Architecture (next) - **Uses this security foundation**
- [Execution Playbook](execution-playbook.md) - Implementation guide

---
