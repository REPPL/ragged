# v0.4.1 - VectorStore Abstraction & Refactoring

**Hours**: 18-22 | **Priority**: P0 - Foundation | **Status**: Planned

**Dependencies**:
- v0.4.0 complete (Plugin architecture)
- v0.3.7 delivered VectorStore abstraction interface

---

## Overview

Refine and integrate the VectorStore abstraction layer from v0.3.7, refactor codebase for memory system integration, and reduce technical debt.

**Vision**: Build upon v0.3.7's VectorStore foundation to create a production-ready abstraction enabling backend flexibility and seamless memory system integration.

**Note**: This release refines and integrates the VectorStore interface initially designed and implemented in v0.3.7, ensuring it's production-ready for v0.4 memory features and v0.4.8 LEANN integration.

---

## Core Deliverables

### 1. VectorStore Abstraction Layer (8-10h)

Based on v0.3's ADR-0015 design, create pluggable vector storage backends.

#### VectorStore Interface (3-4h)
```python
class VectorStore(ABC):
    @abstractmethod
    def add(documents, collection_name) -> List[str]
    @abstractmethod
    def search(query_embedding, n_results, filter_dict) -> QueryResult
    @abstractmethod
    def delete(document_ids, collection_name) -> int
    @abstractmethod
    def update(documents, collection_name) -> int
    @abstractmethod
    def get(document_ids, collection_name) -> List[Document]
    # + collection management methods
```

**Files**:
- `ragged/vectorstore/__init__.py` (~250 lines)
- `ragged/vectorstore/exceptions.py` (~80 lines)

#### ChromaDB Implementation (4-5h)
Refactor existing ChromaDB code into clean `ChromaDBStore` class.

**Files**:
- `ragged/vectorstore/chromadb.py` (~350 lines)

**Modified**:
- `ragged/core/retrieval.py` - Use VectorStore interface
- `ragged/core/ingestion.py` - Use VectorStore interface

#### Integration (1-2h)
- Factory pattern for backend creation
- Configuration management
- Seamless migration

**Files**:
- `ragged/config/settings.py` - VectorStore config

---

### 2. Codebase Refactoring (6-8h)

Prepare architecture for memory system and reduce technical debt.

#### Memory System Preparation (3-4h)
- Create `ragged/memory/` module structure
- Extract retriever/generator interfaces
- Dependency injection patterns

**Files**:
- `ragged/memory/__init__.py` (placeholder)
- `ragged/core/interfaces.py` (~150 lines)

#### Technical Debt Reduction (3-4h)
- Enhanced error handling
- Type safety improvements (mypy strict)
- Code cleanup and deduplication
- Documentation updates

---

### 3. Comprehensive Testing (4h)

Maintain 80%+ coverage with new abstraction layer.

#### Tests Required:
- Interface contract tests (~200 lines)
- ChromaDB implementation tests (~300 lines)
- Factory tests (~100 lines)
- Integration tests (~200 lines)
- Regression tests (all existing pass)

**Total Test Lines**: ~850

---

## Testing Requirements

**Coverage Targets**:
- Overall: ≥80%
- VectorStore module: ≥90%
- Refactored modules: ≥85%

**Quality Checks**:
- ✅ All existing tests pass
- ✅ Performance maintained (<5% overhead)
- ✅ Type checking strict mode passes
- ✅ Contract tests pass for ChromaDB

---

## Documentation

**Required** (~1,000 lines):

1. **ADR-0016**: Memory System Preparation (~300 lines)
   - Module reorganisation decisions
   - Interface extraction rationale

2. **Guide**: VectorStore Backend Development (~400 lines)
   - How to implement backends
   - Interface contracts
   - Testing requirements

3. **Reference**: VectorStore API (~300 lines)
   - Complete API documentation
   - Method signatures
   - Backend-specific notes

---

## Success Criteria

Version 0.4.2 is successful if:

1. ✅ VectorStore abstraction complete and tested
2. ✅ ChromaDB refactored cleanly
3. ✅ All existing tests pass (zero regressions)
4. ✅ 80%+ test coverage maintained
5. ✅ Codebase prepared for memory system
6. ✅ Technical debt reduced
7. ✅ Type safety improved (mypy strict)
8. ✅ Documentation updated
9. ✅ Performance maintained (<5% overhead)
10. ✅ Backend selection ready for v0.4.8

---

## Performance Targets

- Document ingestion: Equivalent to v0.4.1
- Query latency: Equivalent to v0.4.1
- Abstraction overhead: <5%
- Backend switching: <1s

---

## File Summary

**New Files** (~1,930 lines):
- VectorStore: ~680 lines
- Memory prep: ~200 lines
- Tests: ~850 lines
- Documentation: ~1,000 lines

**Modified Files**:
- `ragged/core/retrieval.py`
- `ragged/core/generation.py`
- `ragged/core/ingestion.py`
- `ragged/config/settings.py`

---

## Migration & Compatibility

**Zero Breaking Changes**:
- Default backend remains ChromaDB
- Existing code works unchanged
- Configuration backward compatible

**Configuration**:
```yaml
# New format (old format still works)
vectorstore:
  backend: chromadb  # or "leann" in v0.4.9
  chromadb:
    persist_directory: ./data/chroma
```

---

## Risk Assessment

**Medium Risk**:
- Abstraction performance overhead → Benchmark all operations
- Refactoring regressions → 100% test pass requirement

**Low Risk**:
- Interface design (based on proven v0.3 design)
- ChromaDB refactor (well-understood code)

---

## Related Documentation

- [v0.4 Overview](README.md)
- [v0.4.0](v0.4.0.md) - Plugin architecture (previous)
- [v0.4.2](v0.4.2.md) - Code quality (next)
- **[v0.3.7](../../v0.3/v0.3.7.md) - VectorStore Abstraction (foundation work)**
- [ADR-0015: VectorStore Abstraction](../../../decisions/adrs/0015-vectorstore-abstraction.md)
- [v0.3 Planning](../../../planning/version/v0.3/README.md#vectorstore-abstraction-layer)

---
