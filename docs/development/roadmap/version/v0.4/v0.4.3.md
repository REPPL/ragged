# v0.4.3 - LEANN Backend Integration (Platform-Aware)

**Hours**: 35-42 | **Priority**: P0 - Core Backend | **Status**: Planned

**Dependencies**:
- v0.4.2 complete (VectorStore abstraction)
- v0.4.1 complete (Plugin architecture)

---

## Overview

Integrate LEANN as a mandatory core vector storage backend offering 97% storage savings through graph-based selective recomputation, with platform-aware implementation that gracefully falls back to ChromaDB on unsupported platforms.

**Vision**: ragged uses LEANN as the default backend on macOS/Linux for storage efficiency, while maintaining ChromaDB as a fallback for Windows and other platforms - ensuring cross-platform compatibility without sacrificing ragged's storage-efficient design.

**Strategic Position**: Implementing LEANN **before** the memory system (v0.4.5) allows memory features to be designed with LEANN's storage efficiency from day one, avoiding migration complexity.

**Architectural Change**: Unlike the original conditional approach, LEANN is now **mandatory in architecture** but **optional at runtime** based on platform support - demonstrating ragged's commitment to storage-efficient, privacy-first design while maintaining universal accessibility.

---

## Core Deliverables

### 1. LEANN Backend Implementation (12-16h)

Implement `LeannVectorStore` class for macOS and Linux.

#### LEANN Store Class

```python
class LeannVectorStore(VectorStore):
    """Graph-based vector storage with 97% storage savings."""

    def __init__(self, persist_directory: Path, config: LeannConfig):
        # Graph-based index building
        # On-demand embedding computation
        # Metadata filtering support
        pass

    def add(self, documents: List[Document], collection_name: str) -> List[str]:
        """Add documents to graph-based index."""
        pass

    def search(self, query_embedding: np.ndarray, n_results: int,
               filter_dict: Optional[Dict] = None) -> QueryResult:
        """Graph-based approximate search."""
        pass
```

**Performance Targets**:
- Storage: 97% reduction vs ChromaDB (verified on 10K docs)
- Recall: 90% top-3 (acceptable trade-off for storage savings)
- Query latency: <2s (optimised in v0.4.12)

**Files**:
- `ragged/vectorstore/leann.py` (~400 lines)
- `ragged/vectorstore/leann_config.py` (~100 lines)
- `tests/vectorstore/test_leann.py` (~250 lines)

**Dependencies**:
```toml
[project.dependencies]
chromadb = ">=0.4.0"  # Always available (fallback)

[project.optional-dependencies]
leann = [
    "leann>=1.0.0; platform_system=='Darwin' or platform_system=='Linux'",
    "sentence-transformers>=3.0.0"
]
```

**Installation**:
```bash
# macOS/Linux: Gets LEANN automatically
pip install ragged[leann]

# Windows: ChromaDB only (LEANN not available)
pip install ragged
```

---

### 2. Platform Detection & Auto-Selection (3-5h)

Intelligent backend selection based on platform and availability.

#### Platform Detection

```python
# ragged/vectorstore/factory.py
import platform

def detect_platform_backend_support() -> Dict[str, bool]:
    """Detect which backends are available on current platform."""
    return {
        "chromadb": True,  # Always available
        "leann": _is_leann_available()
    }

def _is_leann_available() -> bool:
    """Check if LEANN is available on current platform."""
    try:
        import leann
        return True
    except ImportError:
        return False

def get_default_backend() -> str:
    """Auto-select best available backend for platform."""
    if _is_leann_available():
        return "leann"  # Prefer LEANN for storage efficiency
    return "chromadb"  # Fallback for unsupported platforms
```

#### User Experience

**On macOS/Linux with LEANN installed**:
```bash
$ ragged init
✓ Detected macOS platform
✓ LEANN backend available (97% storage savings)
→ Using LEANN as default backend
→ To use ChromaDB instead: ragged config set vectorstore.backend chromadb
```

**On Windows or without LEANN**:
```bash
$ ragged init
✓ Detected Windows platform
ℹ LEANN not available on Windows (platform limitation)
→ Using ChromaDB backend (fully functional)
→ All features available (storage savings not available)
```

**Files**:
- `ragged/vectorstore/factory.py` - Enhanced with detection (~50 lines added)
- `ragged/vectorstore/platform.py` (~150 lines)
- `tests/vectorstore/test_platform_detection.py` (~100 lines)

---

### 3. Backend Configuration & Selection (4-6h)

User-facing backend configuration and management.

#### Configuration Schema

```yaml
# ~/.ragged/config.yaml
vectorstore:
  backend: "auto"  # auto, leann, chromadb

  leann:
    persist_directory: "./data/leann"
    graph_degree: 32
    search_complexity: 100

  chromadb:
    persist_directory: "./data/chroma"
    embedding_function: "default"
```

**Backend Values**:
- `"auto"` (default) - Auto-detect best available backend
- `"leann"` - Force LEANN (fails gracefully if unavailable)
- `"chromadb"` - Force ChromaDB (always works)

#### CLI Commands

```bash
# View current backend
ragged backend status

# List available backends
ragged backend list

# Switch backend
ragged backend use leann
ragged backend use chromadb

# Compare backends
ragged backend compare

# Backend statistics
ragged backend stats --backend leann
ragged backend stats --backend chromadb
```

**Files**:
- `ragged/cli/commands/backend.py` (~200 lines)
- Update `ragged/config/settings.py` (~100 lines added)
- `tests/cli/test_backend_commands.py` (~150 lines)

---

### 4. Cross-Platform Testing (6-8h)

Comprehensive testing across all platforms and backend combinations.

#### Platform Test Matrix

| Platform | LEANN Available | ChromaDB Available | Default Backend |
|----------|-----------------|-------------------|-----------------|
| macOS (Intel) | ✅ Yes | ✅ Yes | LEANN |
| macOS (ARM64) | ✅ Yes | ✅ Yes | LEANN |
| Linux (x86_64) | ✅ Yes | ✅ Yes | LEANN |
| Linux (ARM64) | ✅ Yes | ✅ Yes | LEANN |
| Windows | ❌ No | ✅ Yes | ChromaDB |

#### Test Scenarios

**Platform Detection Tests**:
- ✅ Correctly identifies macOS/Linux/Windows
- ✅ Detects LEANN availability
- ✅ Falls back to ChromaDB when LEANN unavailable
- ✅ Respects user override (manual backend selection)

**Functional Tests** (on each platform):
- ✅ Document ingestion works
- ✅ Query retrieval works
- ✅ Backend switching works
- ✅ Configuration persists correctly

**Contract Tests** (LEANN must pass all VectorStore interface tests):
- ✅ `test_vectorstore_contract_leann.py` - All interface methods
- ✅ Storage savings verified (97% reduction)
- ✅ Recall targets met (90% top-3)
- ✅ Query latency within bounds (<2s)

**Cross-Platform CI**:
```yaml
# .github/workflows/test-multiplatform.yml
strategy:
  matrix:
    os: [ubuntu-latest, macos-latest, windows-latest]
    python-version: ['3.11', '3.12']
```

**Files**:
- `tests/vectorstore/test_leann.py` (~250 lines)
- `tests/vectorstore/test_platform_detection.py` (~100 lines)
- `tests/integration/test_cross_platform.py` (~200 lines)
- `.github/workflows/test-multiplatform.yml` (enhanced)

---

### 5. Documentation (6-8h)

Comprehensive documentation for multi-backend architecture.

**Documentation Requirements** (~1,200 lines):

1. **Guide**: Platform-Aware Backend System (~400 lines)
   - How backend selection works
   - Platform support matrix
   - LEANN vs ChromaDB comparison
   - When to use which backend

2. **Guide**: LEANN Installation & Setup (~300 lines)
   - macOS installation (Intel, ARM64)
   - Linux installation (x86_64, ARM64)
   - Windows explanation (not available)
   - Troubleshooting build issues

3. **Reference**: Backend Configuration (~200 lines)
   - Configuration options for both backends
   - Backend CLI commands
   - Platform detection API

4. **Guide**: Cross-Platform Development (~300 lines)
   - Testing on multiple platforms
   - Handling backend-specific code
   - CI/CD for multi-platform

**Backend Comparison Matrix**:

| Feature | ChromaDB | LEANN |
|---------|----------|-------|
| **Storage** | Standard (100%) | 97% savings |
| **Accuracy** | ~100% recall | 90% recall@3 |
| **Query Latency** | <500ms | <2s |
| **Platforms** | All (macOS, Linux, Windows) | macOS, Linux only |
| **Build Complexity** | Simple (pip install) | Complex (C++ toolchain) |
| **Best For** | Windows users, accuracy-critical | Storage-constrained, macOS/Linux |
| **Memory System** | Fully supported | Fully supported (designed for LEANN) |

---

## Testing Requirements

**Coverage**: ≥85% for LEANN module, ≥90% for platform detection

**Platform-Specific Tests**:
- ✅ All tests pass on macOS (Intel, ARM64)
- ✅ All tests pass on Linux (x86_64, ARM64)
- ✅ All tests pass on Windows (ChromaDB fallback)
- ✅ Platform detection works correctly on all platforms
- ✅ Graceful fallback when LEANN unavailable

**Backend Tests**:
- ✅ LEANN passes all VectorStore contract tests
- ✅ Storage savings verified (97% reduction)
- ✅ Retrieval quality validated (90% top-3 recall)
- ✅ Query latency within bounds (<2s)
- ✅ Backend switching works correctly

**Integration Tests**:
- ✅ End-to-end workflows with LEANN backend
- ✅ End-to-end workflows with ChromaDB backend
- ✅ Backend switching mid-workflow
- ✅ Configuration persistence

---

## Success Criteria

Version 0.4.3 is successful if:

1. ✅ LEANN achieves 97% storage savings (verified on 10K docs)
2. ✅ 90% top-3 recall maintained (benchmarked)
3. ✅ Query latency <2s (acceptable for storage savings)
4. ✅ Platform detection works on macOS, Linux, Windows
5. ✅ Graceful fallback to ChromaDB on unsupported platforms
6. ✅ Both backends pass all contract tests
7. ✅ Cross-platform CI passing on all 3 platforms
8. ✅ 85%+ test coverage for LEANN, 90%+ for platform detection
9. ✅ Documentation complete with platform matrix
10. ✅ Users can easily switch backends
11. ✅ Windows users have full functionality (via ChromaDB)
12. ✅ macOS/Linux users get LEANN by default
13. ✅ No breaking changes (backward compatible)
14. ✅ Ready for memory system (v0.4.5) to use multi-backend

---

## Performance Benchmarks

**Storage Efficiency** (verified on 10K documents):
- ChromaDB: ~200MB (baseline)
- LEANN: ~6MB (97% savings)
- **Savings**: 194MB for 10K docs
- **Projected**: 1.2GB → 36MB for 50K docs

**Retrieval Quality** (benchmarked):
- ChromaDB: ~100% recall@10
- LEANN: 90% recall@3 (acceptable trade-off)

**Query Latency** (averaged over 1000 queries):
- ChromaDB: <500ms
- LEANN: <2s (further optimised in v0.4.12)

---

## File Summary

**New Files** (~2,100 lines):
- LEANN backend: ~500 lines
- Platform detection: ~150 lines
- Backend CLI: ~200 lines
- Tests: ~550 lines
- Documentation: ~1,200 lines
- CI/CD enhancements: ~50 lines

**Modified Files**:
- `ragged/vectorstore/factory.py` - Enhanced with platform detection
- `ragged/config/settings.py` - Backend configuration
- `.github/workflows/` - Multi-platform CI

---

## Platform Support Matrix

| Platform | Architecture | LEANN | ChromaDB | Default |
|----------|-------------|-------|----------|---------|
| macOS | Intel (x86_64) | ✅ Yes | ✅ Yes | LEANN |
| macOS | Apple Silicon (ARM64) | ✅ Yes | ✅ Yes | LEANN |
| Linux | x86_64 | ✅ Yes | ✅ Yes | LEANN |
| Linux | ARM64 | ✅ Yes | ✅ Yes | LEANN |
| Windows | x86_64 | ❌ No | ✅ Yes | ChromaDB |
| Windows | ARM64 | ❌ No | ✅ Yes | ChromaDB |

**Future Platform Support**:
- Windows (x86_64, ARM64) - When LEANN Windows builds available (v0.5.x+)

---

## Migration from v0.4.2

**Zero Breaking Changes**:
- Existing ChromaDB installations work unchanged
- Default backend selection is intelligent (auto-detect)
- Configuration backward compatible
- No data migration required

**New Installations**:
```bash
# macOS/Linux users get LEANN automatically
pip install ragged[leann]

# Windows users get ChromaDB (same as before)
pip install ragged
```

---

## Risk Assessment

**Medium Risk**:
- Platform-specific builds → Mitigation: Comprehensive CI on macOS, Linux, Windows
- LEANN optional dependency → Mitigation: Graceful fallback, clear documentation
- Cross-platform compatibility → Mitigation: Extensive platform detection tests

**Low Risk**:
- VectorStore interface (proven in v0.4.2)
- ChromaDB fallback (already working)

---

## Dependency on v0.4.5 (Memory System)

**Critical**: v0.4.5 (Memory Foundation) will be designed with multi-backend support from day one.

**Architecture Flow**:
```
v0.4.2 (VectorStore Abstraction)
    ↓
v0.4.3 (LEANN Backend - platform-aware)
    ↓
v0.4.4 (Code Quality & Security Baseline)
    ↓
v0.4.5 (Memory Foundation - uses multi-backend VectorStore)
```

**Benefits**:
- Memory system storage efficiency from day one (97% savings on macOS/Linux)
- No migration needed for memory data (designed multi-backend from start)
- ChromaDB users and Windows users have full functionality
- LEANN users get storage benefits immediately

---

## Related Documentation

- [v0.4 Overview](README.md) - Release series overview
- [v0.4.2](v0.4.2.md) - VectorStore Abstraction (previous)
- [v0.4.4](v0.4.4.md) - Code Quality (next)
- [v0.4.5](v0.4.5/README.md) - Memory Foundation (uses multi-backend) - **Benefits from LEANN**
- [v0.4.11](v0.4.11.md) - Backend Migration Tools (ChromaDB ↔ LEANN)
- [ADR-0015: VectorStore Abstraction](../../../decisions/adrs/0015-vectorstore-abstraction.md)
- [v0.3.7](../../v0.3/v0.3.7.md) - VectorStore Abstraction (foundation work)

---
