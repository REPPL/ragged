# v0.4.7 - Behaviour Learning Part 1: Topic Extraction & Interest Profiling

**Hours**: 17-20 | **Priority**: P0 - Core Feature | **Status**: Planned

**Dependencies**: v0.4.6 complete (Memory stability established)

---

## Overview

Implement intelligent behaviour learning system with topic extraction and interest profile building based on user interactions.

**Vision**: Ragged learns from user patterns and automatically builds interest profiles over time.

**Theoretical Foundation**: Applies [Context Engineering 2.0](../../../acknowledgements/context-engineering-2.0.md) **context-aware retrieval** principles—moving beyond keyword matching to select context based on learned user interests. Interest profiling reduces uncertainty (entropy reduction) by identifying user focus areas from historical behaviour.

---

## Core Deliverables

### 1. Topic Extraction Engine (4-5h)

Extract topics from queries for interest profiling.

**Phase 1**: Simple keyword-based extraction with frequency analysis
**Future**: NLP/LLM-based extraction (v0.5.x)

#### Implementation

```python
class TopicExtractor:
    """Extract topics from user queries."""

    def extract_topics(self, query: str) -> List[Topic]:
        """Extract topics from query text.

        Args:
            query: User query text

        Returns:
            List of extracted topics with confidence scores
        """
        # Keyword extraction
        # Stop word removal
        # Phrase detection
        # Topic scoring
        pass

    def extract_from_documents(self, doc_ids: List[str]) -> List[Topic]:
        """Extract topics from retrieved documents.

        Args:
            doc_ids: Document IDs that were retrieved

        Returns:
            List of topics from documents
        """
        pass
```

**Features**:
- Keyword-based topic extraction
- Stop word filtering (configurable)
- Multi-word phrase detection
- Confidence scoring per topic
- Configurable extraction parameters

**Example**:
```python
query = "What are the latest RAG techniques for improving retrieval accuracy?"
topics = extractor.extract_topics(query)
# [Topic(name="RAG", confidence=0.95),
#  Topic(name="retrieval accuracy", confidence=0.85),
#  Topic(name="techniques", confidence=0.60)]
```

**Files**:
- `ragged/memory/topics.py` (~250 lines)
- `ragged/memory/topic_config.py` (~100 lines)
- `tests/memory/test_topics.py` (~200 lines)

---

### 2. Interest Profile Builder (8-10h)

Build and maintain user interest profiles based on behaviour patterns.

#### Profile Schema

```python
@dataclass
class InterestProfile:
    """User interest profile."""
    persona: str
    topics: Dict[str, TopicInterest]  # topic_name -> TopicInterest
    created_at: datetime
    updated_at: datetime

@dataclass
class TopicInterest:
    """Single topic interest."""
    topic: str
    frequency: int              # How many times queried
    recency: float              # Time decay factor (0-1)
    confidence: float           # Interest confidence (0-1)
    first_seen: datetime
    last_seen: datetime
    related_documents: List[str]  # Document IDs
    co_occurring_topics: Dict[str, int]  # Related topics
```

#### Features

**Topic Tracking**:
- Track topics queried over time
- Calculate topic frequency
- Apply time decay (recent interests weighted more)
- Detect co-occurring topics

**Confidence Scoring**:
```python
def calculate_confidence(self, topic: str) -> float:
    """Calculate interest confidence for topic.

    Factors:
    - Frequency: How often topic appears
    - Recency: Time since last occurrence (decay)
    - Consistency: Regular vs sporadic interest
    - Depth: How many related documents accessed
    """
    frequency_score = min(frequency / 10, 1.0)  # Normalize
    recency_score = apply_time_decay(last_seen)  # Exponential decay
    consistency_score = calculate_variance(timestamps)
    depth_score = len(related_documents) / 50

    return weighted_average([
        (frequency_score, 0.35),
        (recency_score, 0.30),
        (consistency_score, 0.20),
        (depth_score, 0.15)
    ])
```

**Time Decay**:
- Exponential decay for older topics
- Recent queries weighted higher
- Configurable decay rate

**Files**:
- `ragged/memory/profile.py` (~400 lines)
- `ragged/memory/confidence.py` (~150 lines)
- `tests/memory/test_profile.py` (~250 lines)

---

### 3. Behaviour Learning System (4-5h)

Learn from user interaction patterns and update profiles.

#### Learning Pipeline

```python
class BehaviourLearner:
    """Learn from user behaviour patterns."""

    def process_interaction(self, interaction: Interaction):
        """Process interaction and update profile.

        Flow:
        1. Extract topics from query
        2. Extract topics from retrieved documents
        3. Update interest profile
        4. Detect co-occurring topics
        5. Update knowledge graph
        """
        # Extract topics
        query_topics = self.extractor.extract_topics(interaction.query)
        doc_topics = self.extractor.extract_from_documents(
            interaction.retrieved_doc_ids
        )

        # Update profile
        profile = self.profile_manager.get_profile(interaction.persona)
        for topic in query_topics + doc_topics:
            profile.update_topic_interest(topic)

        # Detect co-occurrence
        self.detect_co_occurrence(query_topics + doc_topics)

        # Update graph
        self.graph.update_relationships(interaction.persona, query_topics)
```

**Features**:
- Automatic profile updates on each interaction
- Topic co-occurrence detection
- Interest trend analysis
- Background learning (async)

**Files**:
- `ragged/memory/behaviour.py` (~300 lines)
- `tests/memory/test_behaviour.py` (~200 lines)

---

### 4. CLI Interest Profile Commands (2h)

User interface for viewing and managing interest profiles.

```bash
# View interest profile
ragged memory profile --persona researcher

# View topics
ragged memory topics --persona researcher --min-confidence 0.5

# View topic details
ragged memory topic-info "RAG" --persona researcher

# View co-occurring topics
ragged memory related-topics "RAG" --persona researcher

# Forget topic (remove from profile)
ragged memory forget-topic "RAG" --persona researcher --confirm
```

**Output Example**:
```bash
$ ragged memory profile --persona researcher

Interest Profile: researcher
Last Updated: 2026-03-15 14:30

Top Topics (by confidence):
1. RAG (confidence: 0.92, frequency: 24, last seen: 2h ago)
2. privacy (confidence: 0.87, frequency: 18, last seen: 1d ago)
3. vector search (confidence: 0.75, frequency: 12, last seen: 3d ago)

Total topics tracked: 37
Profile age: 45 days
```

**Files**:
- Update `ragged/cli/main.py` with profile commands
- `tests/cli/test_profile_commands.py` (~150 lines)

---

## Testing Requirements

**Coverage**: ≥85% for behaviour learning modules

**Test Categories**:

1. **Topic Extraction Tests**:
   - ✅ Single-word topics extracted
   - ✅ Multi-word phrases detected
   - ✅ Stop words filtered
   - ✅ Confidence scores reasonable (0-1 range)
   - ✅ Edge cases: empty query, very long query

2. **Profile Building Tests**:
   - ✅ Profile initialised correctly
   - ✅ Topic interests updated on interaction
   - ✅ Frequency counts accurate
   - ✅ Time decay applies correctly
   - ✅ Confidence calculation reasonable
   - ✅ Co-occurrence detection works

3. **Behaviour Learning Tests**:
   - ✅ Automatic profile updates
   - ✅ Multiple interactions processed
   - ✅ Interest trends detected
   - ✅ Background processing works

4. **Integration Tests**:
   - ✅ End-to-end: query → profile update
   - ✅ Multiple personas isolated
   - ✅ Profile persists across restarts

**Test Files** (~800 lines):
- `tests/memory/test_topics.py` (~200 lines)
- `tests/memory/test_profile.py` (~250 lines)
- `tests/memory/test_behaviour.py` (~200 lines)
- `tests/cli/test_profile_commands.py` (~150 lines)

---

## Documentation

**Required** (~1,000 lines):

1. **Tutorial**: Understanding Your Interest Profile (~300 lines)
   - How ragged learns your interests
   - Viewing your profile
   - Managing topics
   - Privacy considerations

2. **Guide**: Behaviour Learning System (~400 lines)
   - Topic extraction explained
   - Interest confidence calculation
   - Time decay mechanics
   - Co-occurrence detection
   - Customising extraction parameters

3. **Reference**: Behaviour Learning API (~300 lines)
   - TopicExtractor API
   - InterestProfile schema
   - BehaviourLearner API
   - Configuration options

---

## Success Criteria

Version 0.4.7 is successful if:

1. ✅ Topic extraction achieves 80%+ accuracy on test queries
2. ✅ Interest profiles make intuitive sense to users
3. ✅ Confidence scores correlate with actual user interest
4. ✅ Time decay weights recent activity appropriately
5. ✅ Co-occurring topics detected correctly
6. ✅ Profile updates transparent to users
7. ✅ Performance: Topic extraction <50ms, profile update <100ms
8. ✅ 85%+ test coverage
9. ✅ Documentation complete
10. ✅ CLI commands functional and intuitive

---

## Performance Targets

- Topic extraction: <50ms per query
- Profile update: <100ms per interaction
- Profile retrieval: <50ms
- Co-occurrence detection: <200ms
- Interest confidence calculation: <10ms per topic

---

## File Summary

**New Files** (~2,300 lines):
- Behaviour learning core: ~1,200 lines
- Tests: ~800 lines
- Documentation: ~1,000 lines
- CLI additions: ~100 lines

**Dependencies**:
- No new external dependencies (uses standard library)
- Builds on v0.4.5/v0.4.6 memory foundation

---

## Privacy Considerations

**Data Collected**:
- Topics extracted from queries
- Topic frequency and timestamps
- Document-topic relationships

**Privacy Guarantees** (inherited from v0.4.5):
- All data stored locally in `~/.ragged/memory/`
- No external API calls during topic extraction
- User can view all topics tracked
- User can delete specific topics from profile
- User can export profile data
- User can disable behaviour learning entirely

**User Controls**:
```bash
# View all topics being tracked
ragged memory topics --all

# Delete specific topic
ragged memory forget-topic "topic-name" --confirm

# Export profile
ragged memory export profile.json

# Disable behaviour learning
ragged memory disable-learning --persona researcher
```

---

## Configuration

**Behaviour Learning Config** (`~/.ragged/config/memory.yaml`):
```yaml
behaviour_learning:
  enabled: true

  topic_extraction:
    min_topic_length: 3
    max_topics_per_query: 10
    confidence_threshold: 0.3
    stop_words: "default"  # or custom list

  profile_building:
    time_decay_rate: 0.05  # Per day
    min_frequency_for_tracking: 2
    co_occurrence_threshold: 3

  performance:
    async_updates: true
    batch_size: 10
```

---

## Relationship to v0.4.8

**v0.4.7** (this release):
- Topic extraction
- Interest profile building
- Behaviour learning system
- NO personalised ranking (deferred to v0.4.8)

**v0.4.8** (next release):
- Personalised ranking algorithm
- RAG pipeline integration
- Interest profile analytics
- A/B testing framework

**Rationale**: Split original v0.4.5 into two releases:
1. v0.4.7: Build interest profiles (foundation)
2. v0.4.8: Use profiles for personalised ranking (application)

---

## Related Documentation

- [v0.4 Overview](README.md) - Release series overview
- [v0.4 Detailed Spec](v0.4-DETAILED-SPEC.md) - Part 2: Milestone 2
- [v0.4.6](v0.4.6.md) - Memory stability (previous)
- [v0.4.8](v0.4.8.md) - Personalised ranking (next) - **Uses profiles from v0.4.7**
- [v0.4.5 README](v0.4.5/README.md) - Memory foundation

---
