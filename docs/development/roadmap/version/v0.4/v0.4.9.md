# v0.4.9 - LEANN Backend Integration

**Hours**: 35-42 | **Priority**: P1 - Alternative Backend | **Status**: Planned

**Dependencies**:
- v0.4.8 complete (Temporal memory)
- v0.4.2 VectorStore abstraction (refined from v0.3.7)

---

## Overview

Integrate LEANN as optional vector storage backend offering 97% storage savings through graph-based selective recomputation.

**Vision**: Users choose between accuracy (ChromaDB) and storage efficiency (LEANN) based on their needs.

**VectorStore Evolution**: This release completes the multi-backend journey:
- **v0.3.7** (Q2-Q3 2026): VectorStore interface designed and ChromaDB refactored
- **v0.4.2**: Interface refined and production-ready for memory system
- **v0.4.9**: LEANN backend added, demonstrating plugin architecture's power

---

## Core Deliverables

### 1. LEANN Backend Implementation (12-16h)

Implement `LeannVectorStore` class.

**Features**:
- Graph-based index building
- On-demand embedding computation
- Metadata filtering support
- Collection management

**Performance**:
- Storage: 97% reduction vs ChromaDB
- Recall: 90% top-3 (vs ~100% ChromaDB)
- Query latency: <2s

**Files**:
- `ragged/vectorstore/leann.py` (~400 lines)
- `tests/vectorstore/test_leann.py` (~250 lines)

**Dependencies**:
```toml
[project.optional-dependencies]
leann = [
    "leann>=1.0.0",
    "sentence-transformers>=3.0.0"
]
```

**Installation**:
```bash
pip install ragged[leann]
```

---

### 2. Backend Selection & Configuration (4-6h)

User-facing backend selection.

**Configuration**:
```yaml
vectorstore:
  backend: "leann"  # or "chromadb"
  leann:
    persist_directory: "./data/leann"
    graph_degree: 32
    search_complexity: 100
```

**CLI**:
```bash
ragged ingest docs/ --backend leann
ragged query "What is RAG?" --backend chromadb
ragged backend compare
ragged backend stats
```

**Files**:
- `ragged/cli/commands/backend.py` (~200 lines)
- Update config system

---

### 3. Migration Tools (8-12h)

Migrate collections between backends.

**Commands**:
```bash
ragged migrate chromadb-to-leann --collection default --verify
ragged migrate leann-to-chromadb --collection default
```

**Features**:
- Batch migration
- Progress reporting
- Verification
- Rollback on failure

**Files**:
- `ragged/vectorstore/migration.py` (~300 lines)
- `ragged/cli/commands/migrate.py` (~200 lines)
- `tests/vectorstore/test_migration.py` (~250 lines)

---

### 4. Documentation (6-8h)

Comprehensive LEANN documentation.

**Guides** (~1,000 lines):
1. Backend Comparison Guide (~300 lines)
2. LEANN Installation Guide (~250 lines)
3. Migration Guide (~200 lines)
4. Configuration Reference (~150 lines)

**Backend Comparison Matrix**:
| Feature | ChromaDB | LEANN |
|---------|----------|-------|
| Storage | Standard | 97% savings |
| Accuracy | ~100% | 90% top-3 |
| Latency | <500ms | <2s |
| Build | Simple | Complex (C++) |
| Best For | Accuracy | Storage-constrained |

---

### 5. Testing (5-6h)

Comprehensive backend testing.

**Tests**:
- LEANN interface compliance
- Storage savings verification
- Retrieval quality benchmarks
- Migration correctness
- Platform-specific builds

---

## Success Criteria

Version 0.4.9 is successful if:

1. ✅ LEANN achieves 97% storage savings
2. ✅ 90% top-3 recall maintained
3. ✅ Query latency <2s
4. ✅ Migration tools work correctly
5. ✅ Both backends pass contract tests
6. ✅ Documentation complete
7. ✅ Platform builds successful (macOS, Linux)
8. ✅ Optional dependency doesn't break core
9. ✅ Users can choose backend easily
10. ✅ Performance comparison benchmarks available

---

## Performance Benchmarks

**Storage Efficiency**:
- 10K docs ChromaDB: ~200MB
- 10K docs LEANN: ~6MB (97% savings)

**Retrieval Quality**:
- ChromaDB: ~100% recall@10
- LEANN: 90% recall@3

**Query Latency**:
- ChromaDB: <500ms
- LEANN: <2s

---

## File Summary

**New Files** (~2,800 lines):
- LEANN backend: ~400 lines
- Migration: ~500 lines
- CLI: ~400 lines
- Tests: ~500 lines
- Documentation: ~1,000 lines

---

## Platform Support

**Supported**:
- ✅ macOS (Apple Silicon, Intel)
- ✅ Linux (x86_64, ARM64)

**Unsupported** (v0.4.9):
- ❌ Windows (future)

---

## Risk Assessment

**High Risk**:
- Platform-specific builds → Mitigation: Comprehensive testing, CI on multiple platforms
- Optional dependency management → Mitigation: Graceful fallback to ChromaDB

**Medium Risk**:
- Migration data integrity → Mitigation: Verification step, rollback capability

---

## Related Documentation

- [v0.4.0 Detailed Spec](v0.4.0-DETAILED-SPEC.md) - Part 8: LEANN Backend
- [LEANN Integration Analysis](../../../decisions/2025-11-16-leann-integration-analysis.md)
- **VectorStore Evolution**:
  - [v0.3.7](../../v0.3.0/v0.3.7.md) - Initial VectorStore abstraction (foundation)
  - [v0.4.2](v0.4.2.md) - VectorStore refinement for production
  - [ADR-0015: VectorStore Abstraction](../../../decisions/adrs/0015-vectorstore-abstraction.md)
- [v0.4.8](v0.4.8.md) - Temporal memory (previous)
- [v0.4.10](v0.4.10.md) - Production readiness (next)

---

**License**: GPL-3.0 | **Updated**: 2025-11-18
