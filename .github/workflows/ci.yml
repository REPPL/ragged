name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.12"

jobs:
  lint:
    name: Lint (Black, Ruff)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black ruff

      - name: Check formatting with Black
        run: black --check --line-length 100 src/ tests/

      - name: Lint with Ruff
        run: ruff check src/ tests/

  typecheck:
    name: Type Check (MyPy)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Type check with MyPy
        run: mypy src/
        continue-on-error: true  # Don't fail build yet, just report

  test:
    name: Test Suite (Python ${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ["3.12"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
          pip install -e .

      - name: Set up ChromaDB (Docker)
        if: runner.os == 'Linux'
        run: |
          docker run -d -p 8001:8000 \
            -e IS_PERSISTENT=TRUE \
            -e ANONYMIZED_TELEMETRY=FALSE \
            --name chromadb \
            chromadb/chroma:latest

      - name: Set up ChromaDB (native macOS)
        if: runner.os == 'macOS'
        run: |
          pip install chromadb
          # ChromaDB will run in-process for tests

      - name: Wait for ChromaDB
        if: runner.os == 'Linux'
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:8001/api/v1/heartbeat > /dev/null; then
              echo "ChromaDB is ready"
              break
            fi
            echo "Waiting for ChromaDB... ($i/30)"
            sleep 2
          done

      - name: Run unit tests
        run: pytest tests/ -m "unit" -v --tb=short
        env:
          RAGGED_CHROMA_URL: http://localhost:8001
          RAGGED_ENVIRONMENT: testing

      - name: Run integration tests (without Ollama)
        run: pytest tests/ -m "integration and not requires_ollama" -v --tb=short
        env:
          RAGGED_CHROMA_URL: http://localhost:8001
          RAGGED_ENVIRONMENT: testing

  coverage:
    name: Test Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
          pip install -e .
          pip install pytest-cov

      - name: Set up ChromaDB
        run: |
          docker run -d -p 8001:8000 \
            -e IS_PERSISTENT=TRUE \
            -e ANONYMIZED_TELEMETRY=FALSE \
            --name chromadb \
            chromadb/chroma:latest

      - name: Wait for ChromaDB
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:8001/api/v1/heartbeat > /dev/null; then
              echo "ChromaDB is ready"
              break
            fi
            echo "Waiting for ChromaDB... ($i/30)"
            sleep 2
          done

      - name: Run tests with coverage
        run: |
          pytest \
            --cov=src \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term \
            -m "not requires_ollama" \
            -v
        env:
          RAGGED_CHROMA_URL: http://localhost:8001
          RAGGED_ENVIRONMENT: testing

      - name: Check coverage threshold
        run: |
          coverage report --fail-under=68
          echo "Current coverage meets minimum threshold (68%)"
          echo "Target for v1.0: 85%"

      - name: Upload coverage to artifacts
        uses: actions/upload-artifact@v5
        with:
          name: coverage-report
          path: htmlcov/

      - name: Coverage comment
        if: github.event_name == 'pull_request'
        run: |
          echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          coverage report --format=markdown >> $GITHUB_STEP_SUMMARY

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit

      - name: Check dependencies for vulnerabilities
        run: safety check --json || true
        continue-on-error: true

      - name: Run Bandit security scan
        run: bandit -r src/ -f json || true
        continue-on-error: true

  docs:
    name: Documentation Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for broken links in documentation
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.github/markdown-link-check-config.json'
        continue-on-error: true

      - name: Validate documentation structure
        run: |
          # Check that all planning docs have status indicators
          echo "Checking for status indicators in planning docs..."
          # This is a placeholder - could be expanded with actual validation

  build:
    name: Build Package
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build

      - name: Build package
        run: python -m build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v5
        with:
          name: dist-packages
          path: dist/

  all-checks:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test, coverage, build]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.typecheck.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.coverage.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ]; then
            echo "Some checks failed"
            exit 1
          fi
          echo "All checks passed!"
